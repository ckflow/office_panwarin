<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; padding: 20px; }
        .confirm-card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 25px; max-width: 400px; margin: 20px auto; }
        .customer-detail { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
        .detail-label { color: #666; }
        .detail-value { font-weight: bold; }
        .btn-confirm-delete { background: #dc3545; color: white; border: none; border-radius: 25px; padding: 12px 30px; font-size: 16px; font-weight: bold; width: 100%; }
        .btn-confirm-delete:hover { background: #c82333; color: white; }
        .btn-cancel { background: #6c757d; color: white; border: none; border-radius: 25px; padding: 12px 30px; font-size: 16px; width: 100%; margin-top: 10px; }
        .status-msg { text-align: center; padding: 40px 20px; }
        .status-msg.success { color: #198754; }
        .status-msg.error { color: #dc3545; }
        .status-msg.already { color: #ffc107; }
        .warning-list { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 13px; }
        .warning-list ul { margin: 0; padding-left: 20px; }
        .warning-list li { margin: 5px 0; }
    </style>
</head>
<body>

    <div id="loading" class="text-center mt-5">
        <h4>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h4>
    </div>

    <div id="confirmSection" style="display: none;">
        <div class="confirm-card">
            <h4 class="text-center text-danger mb-3">üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
            
            <div class="customer-detail">
                <div class="detail-row">
                    <span class="detail-label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
                    <span class="detail-value" id="customerName">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á:</span>
                    <span class="detail-value" id="priceCount">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô LINE ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å:</span>
                    <span class="detail-value" id="lineCount">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</span>
                    <span class="detail-value" id="roundCount">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏Ç‡∏≠‡∏•‡∏ö‡πÇ‡∏î‡∏¢:</span>
                    <span class="detail-value" id="requestedBy">-</span>
                </div>
            </div>
            
            <div class="warning-list">
                <strong>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:</strong>
                <ul>
                    <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</li>
                    <li>LINE ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ</li>
                    <li>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</li>
                    <li>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</li>
                    <li>‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á</li>
                    <li>‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</li>
                </ul>
            </div>
            
            <div class="alert alert-danger" style="font-size: 13px;">
                ‚ùå ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!
            </div>
            
            <button class="btn-confirm-delete" onclick="confirmDelete()">
                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </button>
            <button class="btn-cancel" onclick="cancelDelete()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>

    <div id="statusSection" style="display: none;">
        <div class="confirm-card">
            <div class="status-msg" id="statusMsg"></div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-mSalEn61";
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        // üî• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        const APPROVER_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093", // ‡πÅ‡∏ä‡∏°‡∏õ‡πå
            "U5a9979d87d7f62faa2917c0253269be0", // ‡πÄ‡∏Æ‡∏µ‡∏¢‡πÄ‡∏Å‡πà‡∏á
        ];
        
        let deletionId = null;
        let customerId = null;
        let currentUserId = null;

        async function main() {
            try {
                // ‡∏î‡∏∂‡∏á parameters ‡∏à‡∏≤‡∏Å URL
                let params = new URLSearchParams(window.location.search);
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ liff.state ‡πÉ‡∏´‡πâ parse ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô
                const liffState = params.get('liff.state');
                if (liffState) {
                    params = new URLSearchParams(liffState);
                }
                
                deletionId = params.get('deletionId');
                customerId = params.get('customerId');
                
                if (!deletionId || !customerId) {
                    showStatus('error', '‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                if (!APPROVER_IDS.includes(currentUserId)) {
                    showStatus('error', '‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    return;
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                await loadCustomerDetail();
                
            } catch (err) {
                showStatus('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
            }
        }
        main();

        async function loadCustomerDetail() {
            try {
                const res = await fetch(`${BASE_URL}/get-customer-deletion-detail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deletionId, customerId })
                });
                const data = await res.json();
                
                if (data.error) {
                    showStatus('error', '‚ùå ' + data.error);
                    return;
                }
                
                if (data.deletion_status === 'approved') {
                    showStatus('already', '‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                if (!data.customer_name) {
                    showStatus('error', '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
                    return;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                document.getElementById('customerName').textContent = data.customer_name || '-';
                document.getElementById('priceCount').textContent = (data.price_count || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                document.getElementById('lineCount').textContent = (data.line_count || 0) + ' ID';
                document.getElementById('roundCount').textContent = (data.round_count || 0) + ' ‡∏£‡∏≠‡∏ö';
                document.getElementById('requestedBy').textContent = data.requested_by || '-';
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('confirmSection').style.display = 'block';
                
            } catch (e) {
                showStatus('error', '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        async function confirmDelete() {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) return;
            
            try {
                const res = await fetch(`${BASE_URL}/confirm-delete-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        deletionId,
                        customerId,
                        approvedBy: currentUserId
                    })
                });
                const result = await res.json();
                
                if (result.success) {
                    showStatus('success', '‚úÖ ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    setTimeout(() => {
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        }
                    }, 2000);
                } else {
                    showStatus('error', '‚ùå ' + (result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                }
            } catch (e) {
                showStatus('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        function cancelDelete() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        function showStatus(type, message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('confirmSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'block';
            
            const msgEl = document.getElementById('statusMsg');
            msgEl.className = 'status-msg ' + type;
            msgEl.innerHTML = `<h4>${message}</h4>`;
        }
    </script>
</body>
</html>