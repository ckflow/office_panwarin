<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 30px; font-family: 'Sarabun', sans-serif; }
        .header-section { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card { border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-header { border-radius: 15px 15px 0 0 !important; font-weight: bold; }
        
        .customer-select-card { background: #fff3cd; border: 1px solid #ffe69c; }
        .deposit-card { background: #d1e7dd; border: 1px solid #badbcc; }
        .leftover-card { background: #cff4fc; border: 1px solid #b6effb; }
        
        .product-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .product-row:last-child { border-bottom: none; }
        .product-name { font-weight: bold; font-size: 14px; }
        .product-icon { font-size: 20px; margin-right: 8px; }
        
        .qty-input { width: 70px; text-align: center; font-size: 16px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 5px; }
        
        .btn-save { border-radius: 30px; padding: 10px 30px; font-weight: bold; }
        
        .status-badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; margin-left: 8px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-used { background: #d4edda; color: #155724; }
        
        .shift-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; }
        .shift-morning { background: #fff3cd; color: #856404; }
        .shift-afternoon { background: #cff4fc; color: #0c5460; }
        
        .history-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-item.used { opacity: 0.7; }
        .history-date { font-size: 11px; color: #666; }
        .history-product { font-weight: bold; }
        .history-qty { color: #0d6efd; font-weight: bold; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f4f6f9; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        .no-permission { text-align: center; padding: 50px 20px; color: #666; }
        
        .section-title { font-size: 14px; color: #6c757d; margin: 15px 0 10px 5px; font-weight: bold; }
        
        .delete-btn { background: none; border: none; color: #dc3545; cursor: pointer; padding: 2px 6px; font-size: 14px; }
        .delete-btn:hover { color: #a71d2a; }
        
        .customer-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; }
        .customer-info .name { font-size: 18px; font-weight: bold; }
        
        .shift-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .shift-btn { flex: 1; padding: 12px; border-radius: 10px; border: 2px solid #ddd; background: white; font-weight: bold; cursor: pointer; text-align: center; transition: all 0.2s; }
        .shift-btn.active { border-color: #0d6efd; background: #e7f1ff; color: #0d6efd; }
        .shift-btn:hover { border-color: #0d6efd; }
        .shift-btn i { margin-right: 5px; }
        
        .shift-required { font-size: 12px; color: #dc3545; margin-bottom: 10px; display: none; }
        .shift-required.show { display: block; }
        
        .view-only-badge { background: #6c757d; color: white; padding: 3px 10px; border-radius: 15px; font-size: 11px; }
        
        /* Page Navigation */
        .page-nav {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin: 15px 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .page-nav-btn {
            flex: 1;
            padding: 8px 5px;
            border: none;
            background: transparent;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
        }
        .page-nav-btn:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        .page-nav-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5>üßä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h5>
    </div>

    <div id="noPermissionScreen" class="no-permission" style="display: none;">
        <h4>üòï ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
        <p>LINE ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</p>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-box me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h5>
                <button onclick="location.reload()" class="btn btn-light btn-sm">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Page Navigation (Admin only) -->
        <div class="page-nav" id="pageNav" style="display: none;">
            <a href="orders.html" class="page-nav-btn">
                <i class="fas fa-clipboard-list"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            </a>
            <a href="index.html" class="page-nav-btn">
                <i class="fas fa-shopping-cart"></i> ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            </a>
            <a href="bags-summary.html" class="page-nav-btn">
                <i class="fas fa-shopping-bag"></i> ‡∏¢‡∏≠‡∏î‡∏ñ‡∏∏‡∏á
            </a>
            <a href="deposit.html" class="page-nav-btn active">
                <i class="fas fa-box"></i> ‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            </a>
        </div>

        <div class="container">
            <!-- Admin: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
            <div id="adminSelectSection" style="display: none;">
                <div class="card customer-select-card">
                    <div class="card-body">
                        <div class="product-name text-warning-emphasis mb-2">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                        <select id="customerSelect" class="form-select" onchange="onCustomerSelect()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á) -->
            <div id="customerInfoSection" style="display: none;">
                <div class="customer-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="name" id="customerNameDisplay">-</div>
                            <div style="font-size: 12px; opacity: 0.8;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                        </div>
                        <span class="view-only-badge" id="viewOnlyBadge" style="display: none;">üëÅÔ∏è ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</span>
                    </div>
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô) -->
            <div id="shopSelectSection" style="display: none;">
                <div class="card" style="background: #e7f1ff; border: 1px solid #b6d4fe;">
                    <div class="card-body">
                        <div class="product-name text-primary mb-2">üè™ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                        <select id="myShopSelect" class="form-select" onchange="onMyShopSelect()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
            <div id="dateFilterSection" style="display: none;">
                <div class="card" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <span style="font-size: 14px;">üìÖ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                            <input type="date" id="filterDate" class="form-control" style="width: 160px; font-size: 14px;" onchange="onDateChange()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô) -->
            <div id="leftoverSection" style="display: none;">
                <div class="section-title">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏î‡∏π)</div>
                
                <!-- ‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                <div class="card leftover-card">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-clipboard-list"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </div>
                    <div class="card-body" id="leftoverList">
                        <div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -</div>
                    </div>
                </div>

                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà (Admin only) -->
                <div id="addLeftoverSection" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        </div>
                        <div class="card-body">
                            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) -->
                            <label style="font-size: 13px; color: #666; margin-bottom: 5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö <span style="color: #dc3545;">*</span></label>
                            <div class="shift-selector" id="leftoverShiftSelector">
                                <div class="shift-btn" data-shift="morning" onclick="selectShift(this, 'leftover')">
                                    <i class="fas fa-sun"></i> ‡∏£‡∏≠‡∏ö‡πÄ‡∏ä‡πâ‡∏≤
                                </div>
                                <div class="shift-btn" data-shift="afternoon" onclick="selectShift(this, 'leftover')">
                                    <i class="fas fa-cloud-sun"></i> ‡∏£‡∏≠‡∏ö‡∏ö‡πà‡∏≤‡∏¢
                                </div>
                            </div>
                            <div class="shift-required" id="leftoverShiftRequired">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                            <input type="hidden" id="leftoverShift" value="">
                            
                            <div class="product-row">
                                <div><span class="product-icon">üçª</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</span></div>
                                <input type="number" id="leftover_tube_l" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">ü•§</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å</span></div>
                                <input type="number" id="leftover_tube_s" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üì¶</span><span class="product-name">‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å</span></div>
                                <input type="number" id="leftover_pack_s" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)</span></div>
                                <input type="number" id="leftover_crush_white" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)</span></div>
                                <input type="number" id="leftover_crush_sack" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <span class="product-icon">üßä</span>
                                    <span class="product-name">‡∏Å‡πâ‡∏≠‡∏ô</span>
                                    <select id="leftover_cube_unit" style="font-size:12px;padding:2px 5px;border-radius:5px;border:1px solid #ced4da;">
                                        <option value="cube_kak">‡∏Å‡∏±‡πä‡∏Å</option>
                                        <option value="cube_hand">‡∏°‡∏∑‡∏≠</option>
                                    </select>
                                </div>
                                <input type="number" id="leftover_cube" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="mt-3">
                                <input type="text" id="leftoverNote" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-info btn-save text-white" onclick="saveLeftover()">
                                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ù‡∏≤‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á) -->
            <div id="depositSection" style="display: none;">
                <div class="section-title">üì¶ ‡∏ù‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏´‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)</div>
                
                <!-- ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å -->
                <div class="card deposit-card">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-box"></i> ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å
                    </div>
                    <div class="card-body" id="pendingDepositList">
                        <div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å -</div>
                    </div>
                </div>

                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ù‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà (Admin only) -->
                <div id="addDepositSection" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å
                        </div>
                        <div class="card-body">
                            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) -->
                            <label style="font-size: 13px; color: #666; margin-bottom: 5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö <span style="color: #dc3545;">*</span></label>
                            <div class="shift-selector" id="depositShiftSelector">
                                <div class="shift-btn" data-shift="morning" onclick="selectShift(this, 'deposit')">
                                    <i class="fas fa-sun"></i> ‡∏£‡∏≠‡∏ö‡πÄ‡∏ä‡πâ‡∏≤
                                </div>
                                <div class="shift-btn" data-shift="afternoon" onclick="selectShift(this, 'deposit')">
                                    <i class="fas fa-cloud-sun"></i> ‡∏£‡∏≠‡∏ö‡∏ö‡πà‡∏≤‡∏¢
                                </div>
                            </div>
                            <div class="shift-required" id="depositShiftRequired">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                            <input type="hidden" id="depositShift" value="">
                            
                            <div class="product-row">
                                <div><span class="product-icon">üçª</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</span></div>
                                <input type="number" id="deposit_tube_l" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">ü•§</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å</span></div>
                                <input type="number" id="deposit_tube_s" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)</span></div>
                                <input type="number" id="deposit_crush_white" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)</span></div>
                                <input type="number" id="deposit_crush_sack" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="mt-3">
                                <input type="text" id="depositNote" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-success btn-save" onclick="saveDeposit()">
                                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏≤‡∏Å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k";
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093",
            "U4cc74cb6346dece926adf6b2a3b7cb77",
            "Ufab5bb133c511730b583f47104965370",
        ];

        const DEPOSIT_PRODUCTS = ['tube_l', 'tube_s', 'crush_white', 'crush_sack'];
        const LEFTOVER_PRODUCTS = ['tube_l', 'tube_s', 'pack_s', 'crush_white', 'crush_sack'];
        
        const productNames = {
            'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà',
            'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å',
            'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å',
            'crush_white': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)',
            'crush_sack': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)',
            'cube_kak': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏Å‡∏±‡πä‡∏Å)',
            'cube_hand': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏°‡∏∑‡∏≠)'
        };

        const productIcons = {
            'tube_l': 'üçª',
            'tube_s': 'ü•§',
            'pack_s': 'üì¶',
            'crush_white': 'üõçÔ∏è',
            'crush_sack': 'üõçÔ∏è',
            'cube_kak': 'üßä',
            'cube_hand': 'üßä'
        };

        const shiftNames = {
            'morning': 'üåÖ ‡πÄ‡∏ä‡πâ‡∏≤',
            'afternoon': 'üå§Ô∏è ‡∏ö‡πà‡∏≤‡∏¢'
        };

        let currentUserId = null;
        let currentCustomerId = null;
        let currentCustomerName = null;
        let isAdmin = false;
        let depositCustomers = [];
        let myShops = [];
        let selectedDate = null;

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isAdmin = ADMIN_IDS.includes(currentUserId);

                if (isAdmin) {
                    // Admin: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ + ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÑ‡∏î‡πâ
                    await loadDepositCustomers();
                    document.getElementById('adminSelectSection').style.display = 'block';
                    document.getElementById('addDepositSection').style.display = 'block';
                    document.getElementById('addLeftoverSection').style.display = 'block';
                    document.getElementById('pageNav').style.display = 'flex';
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                    await loadMyShops();
                }

            } catch (err) {
                console.error(err);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4><button class="btn btn-primary mt-3" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>';
            }
        }
        main();

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function loadMyShops() {
            try {
                const res = await fetch(`${BASE_URL}/get-my-shops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                myShops = await res.json();
                
                if (myShops.length === 0) {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('noPermissionScreen').style.display = 'block';
                } else if (myShops.length === 1) {
                    currentCustomerId = myShops[0].id;
                    currentCustomerName = myShops[0].name;
                    await showCustomerData();
                } else {
                    const select = document.getElementById('myShopSelect');
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>';
                    myShops.forEach(s => {
                        select.innerHTML += `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`;
                    });
                    
                    document.getElementById('shopSelectSection').style.display = 'block';
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                }
                
            } catch (e) {
                console.error('Error loading my shops:', e);
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('noPermissionScreen').style.display = 'block';
            }
        }

        async function onMyShopSelect() {
            const select = document.getElementById('myShopSelect');
            const shopId = select.value;
            
            if (!shopId) {
                currentCustomerId = null;
                currentCustomerName = null;
                document.getElementById('customerInfoSection').style.display = 'none';
                document.getElementById('dateFilterSection').style.display = 'none';
                document.getElementById('depositSection').style.display = 'none';
                document.getElementById('leftoverSection').style.display = 'none';
                return;
            }
            
            currentCustomerId = parseInt(shopId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            await showCustomerData();
        }

        async function showCustomerData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            selectedDate = today;
            
            document.getElementById('customerNameDisplay').textContent = currentCustomerName;
            document.getElementById('customerInfoSection').style.display = 'block';
            document.getElementById('viewOnlyBadge').style.display = isAdmin ? 'none' : 'inline';
            document.getElementById('dateFilterSection').style.display = 'block';
            document.getElementById('leftoverSection').style.display = 'block';
            document.getElementById('depositSection').style.display = 'block';
            
            await loadLeftoverData(currentCustomerId, selectedDate);
            await loadDepositData(currentCustomerId, selectedDate);
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function selectShift(btn, type) {
            const container = btn.parentElement;
            container.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const shift = btn.dataset.shift;
            document.getElementById(type + 'Shift').value = shift;
            document.getElementById(type + 'ShiftRequired').classList.remove('show');
        }

        async function loadDepositCustomers() {
            try {
                const res = await fetch(`${BASE_URL}/get-deposit-customers`);
                depositCustomers = await res.json();

                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                depositCustomers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`;
                });
            } catch (e) {
                console.error('Error loading deposit customers:', e);
            }
        }

        async function onCustomerSelect() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;

            if (!customerId) {
                currentCustomerId = null;
                currentCustomerName = null;
                document.getElementById('dateFilterSection').style.display = 'none';
                document.getElementById('depositSection').style.display = 'none';
                document.getElementById('leftoverSection').style.display = 'none';
                return;
            }

            currentCustomerId = parseInt(customerId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
            selectedDate = today;

            document.getElementById('dateFilterSection').style.display = 'block';
            document.getElementById('leftoverSection').style.display = 'block';
            document.getElementById('depositSection').style.display = 'block';

            await loadLeftoverData(currentCustomerId, selectedDate);
            await loadDepositData(currentCustomerId, selectedDate);
        }

        async function onDateChange() {
            selectedDate = document.getElementById('filterDate').value;
            if (currentCustomerId) {
                await loadLeftoverData(currentCustomerId, selectedDate);
                await loadDepositData(currentCustomerId, selectedDate);
            }
        }

        async function loadDepositData(customerId, filterDate = null) {
            try {
                const res = await fetch(`${BASE_URL}/get-deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId, filterDate })
                });
                const deposits = await res.json();

                const pendingDeposits = deposits.filter(d => d.status === 'pending');
                const usedDeposits = deposits.filter(d => d.status === 'used');
                const allDeposits = [...pendingDeposits, ...usedDeposits];

                const today = new Date().toISOString().split('T')[0];
                const isToday = filterDate === today;
                const noDataText = isToday ? '- ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -' : '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';

                if (allDeposits.length === 0) {
                    document.getElementById('pendingDepositList').innerHTML = 
                        `<div class="text-center text-muted">${noDataText}</div>`;
                } else {
                    document.getElementById('pendingDepositList').innerHTML = allDeposits.map(d => {
                        const pCode = d.product_code || '';
                        const pName = productNames[pCode] || pCode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                        const pIcon = productIcons[pCode] || 'üì¶';
                        const isUsed = d.status === 'used';
                        
                        const statusBadge = isUsed 
                            ? '<span class="status-badge status-used">‚úÖ ‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>' 
                            : '<span class="status-badge status-pending">‚è≥ ‡∏£‡∏≠‡∏´‡∏±‡∏Å</span>';
                        
                        const shiftBadge = d.shift 
                            ? `<span class="shift-badge shift-${d.shift}">${shiftNames[d.shift] || d.shift}</span>`
                            : '';
                        
                        const deleteBtn = (isAdmin && !isUsed) 
                            ? `<button class="delete-btn" onclick="deleteDeposit(${d.id})"><i class="fas fa-trash"></i></button>` 
                            : '';
                        
                        return `
                            <div class="history-item ${isUsed ? 'used' : ''}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="history-product">${pIcon} ${pName}</span>
                                        <span class="history-qty ms-2">${d.quantity || 0} ‡∏ñ‡∏∏‡∏á</span>
                                        ${shiftBadge}
                                        ${statusBadge}
                                    </div>
                                    ${deleteBtn}
                                </div>
                                <div class="history-date">${formatDate(d.created_at)} ${d.note ? '| ' + d.note : ''}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Error loading deposits:', e);
            }
        }

        async function loadLeftoverData(customerId, filterDate = null) {
            try {
                const res = await fetch(`${BASE_URL}/get-leftovers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId, filterDate })
                });
                const leftovers = await res.json();

                const today = new Date().toISOString().split('T')[0];
                const isToday = filterDate === today;
                const noDataText = isToday ? '- ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -' : '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -';

                if (leftovers.length === 0) {
                    document.getElementById('leftoverList').innerHTML = 
                        `<div class="text-center text-muted">${noDataText}</div>`;
                } else {
                    document.getElementById('leftoverList').innerHTML = leftovers.slice(0, 20).map(l => {
                        const pCode = l.product_code || '';
                        const pName = productNames[pCode] || pCode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                        const pIcon = productIcons[pCode] || 'üì¶';
                        
                        const shiftBadge = l.shift 
                            ? `<span class="shift-badge shift-${l.shift}">${shiftNames[l.shift] || l.shift}</span>`
                            : '';
                        
                        const deleteBtn = isAdmin 
                            ? `<button class="delete-btn" onclick="deleteLeftover(${l.id})"><i class="fas fa-trash"></i></button>` 
                            : '';
                        
                        return `
                            <div class="history-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="history-product">${pIcon} ${pName}</span>
                                        <span class="history-qty ms-2">${l.quantity || 0} ‡∏ñ‡∏∏‡∏á</span>
                                        ${shiftBadge}
                                    </div>
                                    ${deleteBtn}
                                </div>
                                <div class="history-date">${formatDate(l.created_at)} ${l.note ? '| ' + l.note : ''}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Error loading leftovers:', e);
            }
        }

        async function saveDeposit() {
            if (!currentCustomerId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const shift = document.getElementById('depositShift').value;
            if (!shift) {
                document.getElementById('depositShiftRequired').classList.add('show');
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢)');
                return;
            }

            const note = document.getElementById('depositNote').value;
            const deposits = [];

            DEPOSIT_PRODUCTS.forEach(code => {
                const qty = parseInt(document.getElementById(`deposit_${code}`).value) || 0;
                if (qty > 0) {
                    deposits.push({ productCode: code, quantity: qty });
                }
            });

            if (deposits.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            try {
                for (const d of deposits) {
                    await fetch(`${BASE_URL}/add-deposit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customerId: currentCustomerId,
                            productCode: d.productCode,
                            quantity: d.quantity,
                            shift: shift,
                            note: note
                        })
                    });
                }

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                DEPOSIT_PRODUCTS.forEach(code => {
                    document.getElementById(`deposit_${code}`).value = '';
                });
                document.getElementById('depositNote').value = '';
                document.getElementById('depositShift').value = '';
                document.getElementById('depositShiftSelector').querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));

                await loadDepositData(currentCustomerId, selectedDate);
            } catch (e) {
                console.error('Error saving deposit:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        async function saveLeftover() {
            if (!currentCustomerId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const shift = document.getElementById('leftoverShift').value;
            if (!shift) {
                document.getElementById('leftoverShiftRequired').classList.add('show');
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢)');
                return;
            }

            const note = document.getElementById('leftoverNote').value;
            const leftovers = [];

            LEFTOVER_PRODUCTS.forEach(code => {
                const qty = parseInt(document.getElementById(`leftover_${code}`).value) || 0;
                if (qty > 0) {
                    leftovers.push({ productCode: code, quantity: qty });
                }
            });

            const cubeQty = parseInt(document.getElementById('leftover_cube').value) || 0;
            if (cubeQty > 0) {
                const cubeUnit = document.getElementById('leftover_cube_unit').value;
                leftovers.push({ productCode: cubeUnit, quantity: cubeQty });
            }

            if (leftovers.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            try {
                for (const l of leftovers) {
                    await fetch(`${BASE_URL}/add-leftover`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customerId: currentCustomerId,
                            productCode: l.productCode,
                            quantity: l.quantity,
                            shift: shift,
                            note: note
                        })
                    });
                }

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                LEFTOVER_PRODUCTS.forEach(code => {
                    document.getElementById(`leftover_${code}`).value = '';
                });
                document.getElementById('leftover_cube').value = '';
                document.getElementById('leftoverNote').value = '';
                document.getElementById('leftoverShift').value = '';
                document.getElementById('leftoverShiftSelector').querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));

                await loadLeftoverData(currentCustomerId, selectedDate);
            } catch (e) {
                console.error('Error saving leftover:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        async function deleteDeposit(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏ô‡∏µ‡πâ?')) return;

            try {
                await fetch(`${BASE_URL}/delete-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ depositId: id })
                });
                await loadDepositData(currentCustomerId, selectedDate);
            } catch (e) {
                console.error('Error deleting deposit:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        async function deleteLeftover(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ?')) return;

            try {
                await fetch(`${BASE_URL}/delete-leftover`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leftoverId: id })
                });
                await loadLeftoverData(currentCustomerId, selectedDate);
            } catch (e) {
                console.error('Error deleting leftover:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
    </script>
</body>
</html>
