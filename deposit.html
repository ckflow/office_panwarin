<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 30px; font-family: 'Sarabun', sans-serif; }
        .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; margin-bottom: 15px; }
        .header-section h4 { margin: 0; }
        
        .card { border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-header { border-radius: 15px 15px 0 0 !important; font-weight: bold; }
        
        .customer-select-card { background: #fff3cd; border: 1px solid #ffe69c; }
        .deposit-card { background: #d1e7dd; border: 1px solid #badbcc; }
        .leftover-card { background: #cff4fc; border: 1px solid #b6effb; }
        
        .product-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .product-row:last-child { border-bottom: none; }
        .product-name { font-weight: bold; font-size: 14px; }
        .product-icon { font-size: 20px; margin-right: 8px; }
        
        .qty-input { width: 70px; text-align: center; font-size: 16px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 5px; }
        .qty-display { font-size: 18px; font-weight: bold; color: #198754; }
        
        .btn-save { border-radius: 30px; padding: 10px 30px; font-weight: bold; }
        
        .status-badge { padding: 3px 10px; border-radius: 20px; font-size: 12px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-used { background: #d4edda; color: #155724; }
        
        .history-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-date { font-size: 11px; color: #666; }
        .history-product { font-weight: bold; }
        .history-qty { color: #0d6efd; font-weight: bold; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f4f6f9; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        .no-permission { text-align: center; padding: 50px 20px; color: #666; }
        
        .section-title { font-size: 14px; color: #6c757d; margin: 15px 0 10px 5px; font-weight: bold; }
        
        .delete-btn { background: none; border: none; color: #dc3545; cursor: pointer; padding: 2px 6px; font-size: 14px; }
        .delete-btn:hover { color: #a71d2a; }
        
        .customer-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; }
        .customer-info .name { font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5>üßä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h5>
    </div>

    <div id="noPermissionScreen" class="no-permission" style="display: none;">
        <h4>üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h4>
        <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ù‡∏≤‡∏Å</p>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="header-section">
            <h4>üßä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
        </div>

        <div class="container">
            <!-- Admin: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
            <div id="adminSelectSection" style="display: none;">
                <div class="card customer-select-card">
                    <div class="card-body">
                        <div class="product-name text-warning-emphasis mb-2">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                        <select id="customerSelect" class="form-select" onchange="onCustomerSelect()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á) -->
            <div id="customerInfoSection" style="display: none;">
                <div class="customer-info">
                    <div class="name" id="customerNameDisplay">-</div>
                    <div style="font-size: 12px; opacity: 0.8;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ù‡∏≤‡∏Å -->
            <div id="depositSection" style="display: none;">
                <div class="section-title">üì¶ ‡∏ù‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏´‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)</div>
                
                <!-- ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á -->
                <div class="card deposit-card">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-box"></i> ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á
                    </div>
                    <div class="card-body" id="pendingDepositList">
                        <div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á -</div>
                    </div>
                </div>

                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ù‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà (Admin only) -->
                <div id="addDepositSection" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å
                        </div>
                        <div class="card-body">
                            <div class="product-row">
                                <div><span class="product-icon">üçª</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</span></div>
                                <input type="number" id="deposit_tube_l" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">ü•§</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å</span></div>
                                <input type="number" id="deposit_tube_s" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)</span></div>
                                <input type="number" id="deposit_crush_white" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)</span></div>
                                <input type="number" id="deposit_crush_sack" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="mt-3">
                                <input type="text" id="depositNote" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-success btn-save" onclick="saveDeposit()">
                                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏≤‡∏Å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ -->
            <div id="leftoverSection" style="display: none;">
                <div class="section-title">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏î‡∏π)</div>
                
                <!-- ‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                <div class="card leftover-card">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-clipboard-list"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </div>
                    <div class="card-body" id="leftoverList">
                        <div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -</div>
                    </div>
                </div>

                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà (Admin only) -->
                <div id="addLeftoverSection" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        </div>
                        <div class="card-body">
                            <div class="product-row">
                                <div><span class="product-icon">üçª</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</span></div>
                                <input type="number" id="leftover_tube_l" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">ü•§</span><span class="product-name">‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å</span></div>
                                <input type="number" id="leftover_tube_s" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)</span></div>
                                <input type="number" id="leftover_crush_white" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="product-row">
                                <div><span class="product-icon">üõçÔ∏è</span><span class="product-name">‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)</span></div>
                                <input type="number" id="leftover_crush_sack" class="qty-input" placeholder="0" min="0">
                            </div>
                            <div class="mt-3">
                                <input type="text" id="leftoverNote" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-info btn-save text-white" onclick="saveLeftover()">
                                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k"; // ‡πÉ‡∏ä‡πâ LIFF ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093",
            "U4cc74cb6346dece926adf6b2a3b7cb77",
            "Ufab5bb133c511730b583f47104965370",
        ];

        const DEPOSIT_PRODUCTS = ['tube_l', 'tube_s', 'crush_white', 'crush_sack'];
        
        const productNames = {
            'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà',
            'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å',
            'crush_white': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)',
            'crush_sack': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)'
        };

        const productIcons = {
            'tube_l': 'üçª',
            'tube_s': 'ü•§',
            'crush_white': 'üõçÔ∏è',
            'crush_sack': 'üõçÔ∏è'
        };

        let currentUserId = null;
        let currentCustomerId = null;
        let currentCustomerName = null;
        let isAdmin = false;
        let depositCustomers = []; // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å

        // Fetch with timeout
        async function fetchWithTimeout(url, options = {}, timeout = 8000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isAdmin = ADMIN_IDS.includes(currentUserId);

                if (isAdmin) {
                    // Admin: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å
                    await loadDepositCustomers();
                    document.getElementById('adminSelectSection').style.display = 'block';
                    document.getElementById('addDepositSection').style.display = 'block';
                    document.getElementById('addLeftoverSection').style.display = 'block';
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å‡πÑ‡∏´‡∏°
                    await checkCustomerPermission();
                }

            } catch (err) {
                console.error(err);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
            }
        }
        main();

        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å (Admin)
        async function loadDepositCustomers() {
            try {
                const res = await fetchWithTimeout(`${BASE_URL}/get-deposit-customers`);
                depositCustomers = await res.json();

                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                depositCustomers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`;
                });
            } catch (e) {
                console.error('Error loading deposit customers:', e);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function checkCustomerPermission() {
            try {
                const res = await fetchWithTimeout(`${BASE_URL}/check-deposit-permission`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                const data = await res.json();

                if (data.hasPermission) {
                    currentCustomerId = data.customerId;
                    currentCustomerName = data.customerName;
                    
                    document.getElementById('customerNameDisplay').textContent = currentCustomerName;
                    document.getElementById('customerInfoSection').style.display = 'block';
                    document.getElementById('depositSection').style.display = 'block';
                    document.getElementById('leftoverSection').style.display = 'block';
                    
                    await loadDepositData(currentCustomerId);
                    await loadLeftoverData(currentCustomerId);
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('noPermissionScreen').style.display = 'block';
                }
            } catch (e) {
                console.error('Error checking permission:', e);
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('noPermissionScreen').style.display = 'block';
            }
        }

        // Admin ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function onCustomerSelect() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;

            if (!customerId) {
                currentCustomerId = null;
                currentCustomerName = null;
                document.getElementById('depositSection').style.display = 'none';
                document.getElementById('leftoverSection').style.display = 'none';
                return;
            }

            currentCustomerId = parseInt(customerId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;

            document.getElementById('depositSection').style.display = 'block';
            document.getElementById('leftoverSection').style.display = 'block';

            await loadDepositData(currentCustomerId);
            await loadLeftoverData(currentCustomerId);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏≤‡∏Å
        async function loadDepositData(customerId) {
            try {
                const res = await fetchWithTimeout(`${BASE_URL}/get-deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const deposits = await res.json();

                const pendingDeposits = deposits.filter(d => d.status === 'pending');

                if (pendingDeposits.length === 0) {
                    document.getElementById('pendingDepositList').innerHTML = 
                        '<div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á -</div>';
                } else {
                    document.getElementById('pendingDepositList').innerHTML = pendingDeposits.map(d => `
                        <div class="history-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="history-product">${productIcons[d.product_code]} ${productNames[d.product_code]}</span>
                                    <span class="history-qty ms-2">${d.quantity} ‡∏ñ‡∏∏‡∏á</span>
                                </div>
                                ${isAdmin ? `<button class="delete-btn" onclick="deleteDeposit(${d.id})"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                            <div class="history-date">${formatDate(d.created_at)} ${d.note ? '| ' + d.note : ''}</div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading deposits:', e);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        async function loadLeftoverData(customerId) {
            try {
                const res = await fetchWithTimeout(`${BASE_URL}/get-leftovers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const leftovers = await res.json();

                if (leftovers.length === 0) {
                    document.getElementById('leftoverList').innerHTML = 
                        '<div class="text-center text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -</div>';
                } else {
                    document.getElementById('leftoverList').innerHTML = leftovers.slice(0, 10).map(l => `
                        <div class="history-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="history-product">${productIcons[l.product_code]} ${productNames[l.product_code]}</span>
                                    <span class="history-qty ms-2">${l.quantity} ‡∏ñ‡∏∏‡∏á</span>
                                </div>
                                ${isAdmin ? `<button class="delete-btn" onclick="deleteLeftover(${l.id})"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                            <div class="history-date">${formatDate(l.created_at)} ${l.note ? '| ' + l.note : ''}</div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading leftovers:', e);
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏≤‡∏Å
        async function saveDeposit() {
            if (!currentCustomerId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const note = document.getElementById('depositNote').value;
            const deposits = [];

            DEPOSIT_PRODUCTS.forEach(code => {
                const qty = parseInt(document.getElementById(`deposit_${code}`).value) || 0;
                if (qty > 0) {
                    deposits.push({ productCode: code, quantity: qty });
                }
            });

            if (deposits.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            try {
                for (const d of deposits) {
                    await fetchWithTimeout(`${BASE_URL}/add-deposit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customerId: currentCustomerId,
                            productCode: d.productCode,
                            quantity: d.quantity,
                            note: note
                        })
                    });
                }

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ù‡∏≤‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Clear form
                DEPOSIT_PRODUCTS.forEach(code => {
                    document.getElementById(`deposit_${code}`).value = '';
                });
                document.getElementById('depositNote').value = '';

                await loadDepositData(currentCustomerId);
            } catch (e) {
                console.error('Error saving deposit:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        async function saveLeftover() {
            if (!currentCustomerId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const note = document.getElementById('leftoverNote').value;
            const leftovers = [];

            DEPOSIT_PRODUCTS.forEach(code => {
                const qty = parseInt(document.getElementById(`leftover_${code}`).value) || 0;
                if (qty > 0) {
                    leftovers.push({ productCode: code, quantity: qty });
                }
            });

            if (leftovers.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            try {
                for (const l of leftovers) {
                    await fetchWithTimeout(`${BASE_URL}/add-leftover`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customerId: currentCustomerId,
                            productCode: l.productCode,
                            quantity: l.quantity,
                            note: note
                        })
                    });
                }

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Clear form
                DEPOSIT_PRODUCTS.forEach(code => {
                    document.getElementById(`leftover_${code}`).value = '';
                });
                document.getElementById('leftoverNote').value = '';

                await loadLeftoverData(currentCustomerId);
            } catch (e) {
                console.error('Error saving leftover:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // ‡∏•‡∏ö‡∏ù‡∏≤‡∏Å
        async function deleteDeposit(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏ô‡∏µ‡πâ?')) return;

            try {
                await fetchWithTimeout(`${BASE_URL}/delete-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ depositId: id })
                });
                await loadDepositData(currentCustomerId);
            } catch (e) {
                console.error('Error deleting deposit:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // ‡∏•‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        async function deleteLeftover(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ?')) return;

            try {
                await fetchWithTimeout(`${BASE_URL}/delete-leftover`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leftoverId: id })
                });
                await loadLeftoverData(currentCustomerId);
            } catch (e) {
                console.error('Error deleting leftover:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }
    </script>
</body>
</html>
