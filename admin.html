<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; padding: 20px; padding-bottom: 80px; }
        .customer-card { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; display: flex; }
        .customer-card-main { flex: 1; }
        .customer-card-delete { width: 45px; background: #f8f9fa; border-left: 1px solid #eee; display: flex; align-items: center; justify-content: center; }
        .customer-card-delete button { background: none; border: none; color: #dc3545; font-size: 14px; padding: 10px; cursor: pointer; opacity: 0.6; }
        .customer-card-delete button:hover { opacity: 1; background: #fee; }
        .card-header-custom { padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-header-custom:hover { background-color: #f9f9f9; }
        .card-body-custom { padding: 15px; display: none; background-color: #fafafa; }
        
        .section-title { font-size: 13px; color: #888; margin: 12px 0 6px 0; font-weight: bold; display: flex; align-items: center; }
        .section-title .title-text { width: 33%; }
        .section-title .title-btn { width: 34%; text-align: center; }
        .section-title .title-space { width: 33%; }
        .section-title:first-child { margin-top: 0; }
        
        .price-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: white; border-radius: 8px; margin-bottom: 4px; border: 1px solid #eee; }
        .price-item .name { font-size: 14px; }
        .price-item .value { font-weight: bold; color: #198754; }
        .price-item .btn-del { color: #dc3545; background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 12px; }
        
        .multiplier-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: white; border-radius: 8px; margin-bottom: 4px; border: 1px solid #d4edda; }
        .multiplier-item .name { font-size: 14px; }
        .multiplier-item .value { font-weight: bold; color: #0d6efd; }
        .multiplier-item .btn-del { color: #dc3545; background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 12px; }
        
        .multiplier-warning { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 8px 10px; margin-bottom: 4px; font-size: 12px; color: #856404; }
        
        .line-id-tag { background: #e7f1ff; padding: 5px 10px; border-radius: 8px; font-size: 12px; color: #0d6efd; margin: 3px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        
        .promo-section { background: #fff9e6; border: 1px solid #ffe69c; border-radius: 10px; padding: 10px; margin-top: 10px; }
        .promo-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .promo-header h6 { margin: 0; font-size: 13px; color: #856404; }
        .promo-body { display: none; margin-top: 10px; }
        
        .promo-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: white; border-radius: 8px; margin-bottom: 4px; border: 1px solid #ffe69c; }
        .promo-item .info { flex: 1; }
        .promo-item .product { font-size: 14px; font-weight: 500; }
        .promo-item .detail { font-size: 11px; color: #666; }
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        
        .btn-action-group { display: flex; gap: 5px; margin-top: 12px; flex-wrap: wrap; }
        .btn-action-group button { flex: 1; min-width: 90px; border-radius: 8px; font-size: 12px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        
        .empty-text { text-align: center; color: #999; font-size: 12px; padding: 10px; }
        
        /* Round Items */
        .round-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border-radius: 8px; margin-bottom: 6px; border: 1px solid #d1e7dd; }
        .round-item.extra { border-color: #f8d7da; background: #fff5f5; }
        .round-item .round-info { flex: 1; }
        .round-item .round-name { font-size: 14px; font-weight: bold; color: #198754; }
        .round-item.extra .round-name { color: #dc3545; }
        .round-item .round-time { font-size: 12px; color: #666; }
        .round-item .round-quota { font-size: 11px; color: #0d6efd; margin-top: 2px; }
        .round-item .round-driver { font-size: 11px; color: #6c757d; margin-top: 2px; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .round-item .round-actions { display: flex; gap: 5px; align-items: center; }
        .round-item .btn-unlock { font-size: 11px; padding: 3px 8px; }
        .round-item .btn-del { color: #dc3545; background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 12px; }
        
        .round-locked { color: #dc3545; font-size: 11px; }
        .round-unlocked { color: #198754; font-size: 11px; }
    </style>
</head>
<body>

    <div id="auth-check" class="text-center mt-5"><h4>üîí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</h4></div>

    <div id="content" class="container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h4 class="text-primary fw-bold mb-0">üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4></div>
            <div>
                <a href="orders.html" class="btn btn-outline-primary btn-sm"><i class="fas fa-receipt"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</a>
                <a href="drivers.html" class="btn btn-outline-info btn-sm ms-1"><i class="fas fa-truck"></i> ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</a>
                <button class="btn btn-success btn-sm shadow-sm ms-1" onclick="openCreateCustomerModal()"><i class="fas fa-user-plus"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="window.location.reload()"><i class="fas fa-sync"></i></button>
            </div>
        </div>
        <div id="customer-list"><div class="text-center text-muted mt-5">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>
    </div>

    <!-- Modal: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE ID -->
    <div id="manageLineModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center text-primary"><i class="fab fa-line"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE ID</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="lineModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="small text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ:</label>
                <div id="lineIdList" style="background: #f8f9fa; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                    <div class="text-center text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted">‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÉ‡∏´‡∏°‡πà (‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á/‡∏™‡∏≤‡∏Ç‡∏≤):</label>
                <div class="input-group">
                    <input type="text" id="newLineIdInput" class="form-control" placeholder="Uxxxxxxxx..." style="font-size: 14px;">
                    <button class="btn btn-primary" onclick="addLineId()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>

            <button class="btn btn-light w-100" onclick="closeModal('manageLineModal')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- Modal: ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ -->
    <div id="addPriceModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center">üí∞ ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="priceModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <select id="priceProductCode" class="form-select"></select>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="priceValue" class="form-control form-control-lg" placeholder="0">
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-light flex-grow-1" onclick="closeModal('addPriceModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary flex-grow-1" onclick="savePrice()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal: ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á -->
    <div id="addMultiplierModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center">üõçÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏°</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="multiplierModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <select id="multiplierProductCode" class="form-select" onchange="updateMultiplierOptions()">
                    <option value="crush_sachet">‡∏ö‡∏î(‡∏ã‡∏≠‡∏á)</option>
                    <option value="cube_kak">‡∏Å‡πâ‡∏≠‡∏ô(‡∏•‡∏π‡∏Å)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì</label>
                <select id="multiplierValue" class="form-select form-select-lg">
                    <option value="6">√ó6</option>
                    <option value="7">√ó7</option>
                    <option value="8">√ó8</option>
                </select>
                <div class="form-text" id="multiplierHint">‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡πà‡∏á 2 ‡∏ã‡∏≠‡∏á √ó 6 = ‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏° 12 ‡πÉ‡∏ö</div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-light flex-grow-1" onclick="closeModal('addMultiplierModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-success flex-grow-1" onclick="saveMultiplier()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô -->
    <div id="addPromoModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center">üéÅ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="promoModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <select id="promoProductCode" class="form-select"></select>
            </div>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏õ‡∏£</label>
                <select id="promoType" class="form-select" onchange="togglePromoFields()">
                    <option value="buy_x_free_y">‡∏ã‡∏∑‡πâ‡∏≠ X ‡πÅ‡∏ñ‡∏° Y (‡πÄ‡∏ä‡πà‡∏ô 10 ‡πÅ‡∏ñ‡∏° 1)</option>
                    <option value="first_bill_free">‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏ñ‡∏°‡∏ü‡∏£‡∏µ</option>
                </select>
            </div>
            
            <div id="buyXFreeYFields">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label small text-muted">‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ñ‡∏∏‡∏á)</label>
                        <input type="number" id="promoBuyQty" class="form-control" placeholder="10" value="10">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">‡πÅ‡∏ñ‡∏° (‡∏ñ‡∏∏‡∏á)</label>
                        <input type="number" id="promoFreeQty" class="form-control" placeholder="1" value="1">
                    </div>
                </div>
            </div>
            
            <div id="firstBillFields" style="display: none;">
                <div class="mb-3">
                    <label class="form-label small text-muted">‡πÅ‡∏ñ‡∏° (‡∏ñ‡∏∏‡∏á)</label>
                    <input type="number" id="promoFirstBillFreeQty" class="form-control" placeholder="1" value="1">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="form-label small text-muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="text" id="promoNote" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå">
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-light flex-grow-1" onclick="closeModal('addPromoModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-warning flex-grow-1" onclick="savePromo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
    <div id="createCustomerModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center text-success"><i class="fas fa-user-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
            <div class="mb-3">
                <input type="text" id="newCustomerName" class="form-control form-control-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
            </div>
            <div class="mb-4">
                <input type="text" id="newCustomerLineId" class="form-control" placeholder="LINE User ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light flex-grow-1" onclick="closeModal('createCustomerModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-success flex-grow-1" onclick="submitNewCustomer()">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <!-- Modal: ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
    <div id="addRoundModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center text-success">üöö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="roundModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</label>
                <select id="roundNumber" class="form-select" onchange="onRoundNumberChange()">
                    <option value="1">‡∏£‡∏≠‡∏ö 1</option>
                    <option value="2">‡∏£‡∏≠‡∏ö 2</option>
                    <option value="3">‡∏£‡∏≠‡∏ö 3</option>
                    <option value="extra">‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
                </select>
            </div>
            
            <div id="roundTimeFields">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label small text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                        <input type="time" id="roundTimeStart" class="form-control" value="06:00">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="time" id="roundTimeEnd" class="form-control" value="08:00">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label small text-muted">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏¢‡∏π‡∏ô‡∏¥‡∏ï+‡∏ö‡∏î (tube, pack, crush, sack)</label>
                <input type="number" id="roundQuotaBags" class="form-control" placeholder="0" value="50">
            </div>
            
            <div class="mb-4">
                <label class="form-label small text-muted">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Å‡πâ‡∏≠‡∏ô ‡∏ã‡∏≠‡∏á (cube_sachet, cube_kak, cube_hand)</label>
                <input type="number" id="roundQuotaCubes" class="form-control" placeholder="0" value="100">
            </div>
            
            <div class="mb-4">
                <label class="form-label small text-muted">üöó ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                <select id="roundDeliveryGroup" class="form-select">
                    <option value="">-- ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á --</option>
                </select>
                <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-light flex-grow-1" onclick="closeModal('addRoundModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-success flex-grow-1" onclick="saveRound()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k";
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093", //‡πÅ‡∏ä‡∏°‡∏õ‡πå
            "U4cc74cb6346dece926adf6b2a3b7cb77", //‡∏ö‡∏µ
            "Ufab5bb133c511730b583f47104965370", //‡∏Å‡πâ‡∏≠‡∏¢
        ];
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";

        // API Endpoints
        const API = {
            GET_PRICES: `${BASE_URL}/get-prices`,
            GET_PRODUCTS: `${BASE_URL}/get-products`,
            GET_LINES: `${BASE_URL}/get-lines`,
            GET_PROMOS: `${BASE_URL}/get-promos`,
            GET_MULTIPLIERS: `${BASE_URL}/get-multipliers`,
            GET_ROUNDS: `${BASE_URL}/get-customer-rounds`,
            ADD_CUSTOMER: `${BASE_URL}/add-customer`,
            DELETE_CUSTOMER: `${BASE_URL}/delete-customer`,
            ADD_LINE: `${BASE_URL}/add-line`,
            DELETE_LINE: `${BASE_URL}/delete-line`,
            SAVE_PRICE: `${BASE_URL}/save-price`,
            DELETE_PRICE: `${BASE_URL}/delete-price`,
            ADD_PROMO: `${BASE_URL}/add-promo`,
            DELETE_PROMO: `${BASE_URL}/delete-promo`,
            SAVE_MULTIPLIER: `${BASE_URL}/save-multiplier`,
            DELETE_MULTIPLIER: `${BASE_URL}/delete-multiplier`,
            UPDATE_SETTINGS: `${BASE_URL}/update-customer-settings`,
            UPDATE_DEPOSIT_PERMISSION: `${BASE_URL}/update-deposit-permission`,
            SAVE_ROUND: `${BASE_URL}/save-customer-round`,
            DELETE_ROUND: `${BASE_URL}/delete-customer-round`,
            TOGGLE_EXTRA_ROUND: `${BASE_URL}/toggle-extra-round`,
            GET_DELIVERY_GROUPS: `${BASE_URL}/get-delivery-groups`
        };

        let currentCustomer = { id: null, name: '' };
        let productsCache = [];
        let multipliersCache = {};
        let roundsCache = {};
        let deliveryGroupsCache = [];

        // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì
        const MULTIPLIER_PRODUCTS = {
            'crush_sachet': { name: '‡∏ö‡∏î(‡∏ã‡∏≠‡∏á)', options: [6, 7, 8] },
            'cube_kak': { name: '‡∏Å‡πâ‡∏≠‡∏ô(‡∏•‡∏π‡∏Å)', options: [2] }
        };

        // ==================== INIT ====================
        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                if (!ADMIN_IDS.includes(profile.userId)) {
                    document.getElementById('auth-check').innerHTML = `<h3 class="text-danger">‚õî Access Denied</h3>`;
                    return;
                }
                
                document.getElementById('auth-check').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                await loadProducts();
                await loadDeliveryGroups();
                await loadCustomers();
            } catch (err) {
                alert("Error: " + err);
            }
        }
        main();

        // ==================== LOAD DATA ====================
        async function loadProducts() {
            try {
                const res = await fetch(API.GET_PRODUCTS);
                productsCache = await res.json();
                initProductDropdowns();
            } catch (e) {
                console.error('Error loading products:', e);
            }
        }

        function initProductDropdowns() {
            ['priceProductCode', 'promoProductCode'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    productsCache.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.code;
                        opt.textContent = p.name;
                        select.appendChild(opt);
                    });
                }
            });
        }

        async function loadDeliveryGroups() {
            try {
                const res = await fetch(API.GET_DELIVERY_GROUPS);
                deliveryGroupsCache = await res.json();
                initDeliveryGroupDropdown();
            } catch (e) {
                console.error('Error loading delivery groups:', e);
                deliveryGroupsCache = [];
            }
        }

        function initDeliveryGroupDropdown() {
            const select = document.getElementById('roundDeliveryGroup');
            if (select) {
                select.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á --</option>';
                deliveryGroupsCache.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = 'üöó ' + g.name;
                    select.appendChild(opt);
                });
            }
        }

        async function loadCustomers() {
            try {
                const res = await fetch(API.GET_PRICES);
                const data = await res.json();
                await renderCards(data);
            } catch (e) {
                console.error('Error loading customers:', e);
            }
        }

        async function loadMultipliers(customerId) {
            try {
                const res = await fetch(API.GET_MULTIPLIERS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const data = await res.json();
                multipliersCache[customerId] = data;
                return data;
            } catch (e) {
                console.error('Error loading multipliers:', e);
                return [];
            }
        }

        async function loadRounds(customerId) {
            try {
                const res = await fetch(API.GET_ROUNDS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const data = await res.json();
                roundsCache[customerId] = Array.isArray(data) ? data : [];
                return roundsCache[customerId];
            } catch (e) {
                console.error('Error loading rounds:', e);
                return [];
            }
        }

        async function renderCards(data) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';

            // Group by customer
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.customer_id]) {
                    grouped[item.customer_id] = {
                        id: item.customer_id,
                        name: item.customer_name,
                        can_see_price: item.can_see_price,
                        can_deposit: item.can_deposit,
                        prices: []
                    };
                }
                if (item.product_code && item.price) {
                    grouped[item.customer_id].prices.push({
                        id: item.price_id,
                        product_code: item.product_code,
                        product_name: item.product_name,
                        price: item.price
                    });
                }
            });

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = '<div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>';
                return;
            }

            // ‡πÇ‡∏´‡∏•‡∏î multipliers ‡πÅ‡∏•‡∏∞ rounds ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            const customerIds = Object.keys(grouped);
            await Promise.all([
                ...customerIds.map(id => loadMultipliers(id)),
                ...customerIds.map(id => loadRounds(id))
            ]);

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ, A-Z
            const sortedCustomers = Object.values(grouped).sort((a, b) => a.name.localeCompare(b.name, 'th'));

            sortedCustomers.forEach(customer => {
                // ‡∏î‡∏∂‡∏á multipliers ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
                const custMultipliers = multipliersCache[customer.id] || [];
                
                // Prices HTML
                let pricesHtml = '';
                if (customer.prices.length > 0) {
                    pricesHtml = customer.prices.map(p => {
                        let multiplierBadge = '';
                        if (MULTIPLIER_PRODUCTS[p.product_code]) {
                            const mult = custMultipliers.find(m => m.product_code === p.product_code);
                            if (mult) {
                                multiplierBadge = `<span class="badge bg-info ms-2">√ó${mult.multiplier}‡∏ñ‡∏∏‡∏á</span>`;
                            } else {
                                multiplierBadge = `<span class="badge bg-warning text-dark ms-2">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì</span>`;
                            }
                        }
                        return `
                            <div class="price-item">
                                <span class="name">${p.product_name}${multiplierBadge}</span>
                                <span class="value">${p.price} ‡∏ö‡∏≤‡∏ó</span>
                                <button class="btn-del" onclick="deletePrice(${p.id}, '${p.product_name}', ${customer.id}, '${customer.name}')">‚úï</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    pricesHtml = '<div class="empty-text">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ -</div>';
                }

                const cardHtml = `
                    <div class="customer-card">
                        <div class="customer-card-main">
                            <div class="card-header-custom" onclick="toggleCard(this)">
                                <span>üë§ ${customer.name}</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="card-body-custom">
                                <!-- ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
                                <div class="section-title">
                                    <span class="title-text">üöö ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>
                                    <span class="title-btn">
                                        <button class="btn btn-sm btn-success" style="font-size:11px;padding:2px 12px;" onclick="openAddRoundModal(${customer.id}, '${customer.name}')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö</button>
                                    </span>
                                    <span class="title-space"></span>
                                </div>
                                <div id="rounds-${customer.id}" style="margin-bottom:10px;">
                                    <div class="empty-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                                </div>

                                <!-- LINE ID -->
                                <div class="section-title">
                                    <span class="title-text">üì± LINE ID</span>
                                    <span class="title-btn">
                                        <button class="btn btn-sm btn-outline-primary" style="font-size:11px;padding:2px 12px;" onclick="openManageLineModal(${customer.id}, '${customer.name}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                                    </span>
                                    <span class="title-space"></span>
                                </div>
                                <div id="lines-${customer.id}" style="margin-bottom:10px;"></div>

                                <!-- ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å -->
                                <div class="section-title">
                                    <span class="title-text">üì¶ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å</span>
                                    <span class="title-btn"></span>
                                    <span class="title-space"></span>
                                </div>
                                <div style="margin-bottom:10px; padding: 8px 10px; background: white; border-radius: 8px; border: 1px solid #eee;">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="deposit-${customer.id}" 
                                            ${customer.can_deposit ? 'checked' : ''} 
                                            onchange="toggleDepositPermission(${customer.id}, this.checked)">
                                        <label class="form-check-label" for="deposit-${customer.id}" style="font-size:13px;">
                                            ${customer.can_deposit ? '‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å'}
                                        </label>
                                    </div>
                                </div>

                                <!-- ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á -->
                                <div class="section-title">
                                    <span class="title-text">üõçÔ∏è ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á</span>
                                    <span class="title-btn">
                                        <button class="btn btn-sm btn-success" style="font-size:11px;padding:2px 12px;" onclick="openAddMultiplierModal(${customer.id}, '${customer.name}')">+ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                                    </span>
                                    <span class="title-space"></span>
                                </div>
                                <div id="multipliers-${customer.id}" style="margin-bottom:10px;">
                                    <div class="empty-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                                </div>

                                <!-- ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô -->
                                <div class="section-title">
                                    <span class="title-text">üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</span>
                                    <span class="title-btn">
                                        <button class="btn btn-sm btn-warning" style="font-size:11px;padding:2px 12px;" onclick="togglePromoSection(this, ${customer.id})">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‚ñº</button>
                                    </span>
                                    <span class="title-space"></span>
                                </div>
                                <div class="promo-body" id="promos-${customer.id}" style="display:none; margin-top:8px;">
                                    <div class="empty-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                                </div>

                                <!-- ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                                <div class="section-title mt-3">
                                    <span class="title-text">üí∞ ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                                    <span class="title-btn">
                                        <button class="btn btn-sm btn-primary" style="font-size:11px;padding:2px 12px;" onclick="openAddPriceModal(${customer.id}, '${customer.name}')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                    </span>
                                    <span class="title-space"></span>
                                </div>
                                <div style="margin-bottom:10px;">
                                    ${pricesHtml}
                                </div>
                            </div>
                        </div>
                        <div class="customer-card-delete">
                            <button onclick="deleteCustomer(${customer.id}, '${customer.name}')" title="‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);

                // Load multipliers and rounds for this customer
                loadAndRenderMultipliers(customer.id);
                loadAndRenderRounds(customer.id);
            });
        }

        // ==================== ROUNDS SECTION ====================
        async function loadAndRenderRounds(customerId) {
            const container = document.getElementById(`rounds-${customerId}`);
            const rounds = await loadRounds(customerId);
            
            if (rounds.length === 0) {
                container.innerHTML = `<div class="multiplier-warning">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</div>`;
                return;
            }
            
            // Sort: 1, 2, 3, extra
            const order = { '1': 1, '2': 2, '3': 3, 'extra': 4 };
            rounds.sort((a, b) => (order[a.round_number] || 99) - (order[b.round_number] || 99));
            
            let html = rounds.map(r => {
                const isExtra = r.round_number === 'extra';
                const roundName = isExtra ? '‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°' : `‡∏£‡∏≠‡∏ö ${r.round_number}`;
                const timeText = isExtra ? '' : `${formatTime(r.time_start)} - ${formatTime(r.time_end)}`;
                
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
                let driverGroupText = '';
                if (r.delivery_group_id) {
                    const group = deliveryGroupsCache.find(g => g.id == r.delivery_group_id);
                    if (group) {
                        driverGroupText = `<div class="round-driver">üöó ${group.name}</div>`;
                    }
                }
                
                let lockStatus = '';
                let lockBtn = '';
                if (isExtra) {
                    if (r.is_unlocked) {
                        lockStatus = `<span class="round-unlocked">üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</span>`;
                        lockBtn = `<button class="btn btn-outline-danger btn-unlock" onclick="toggleExtraRound(${r.id}, ${customerId}, false)">‡∏•‡πá‡∏≠‡∏Ñ</button>`;
                    } else {
                        lockStatus = `<span class="round-locked">üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà</span>`;
                        lockBtn = `<button class="btn btn-outline-success btn-unlock" onclick="toggleExtraRound(${r.id}, ${customerId}, true)">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ</button>`;
                    }
                }
                
                return `
                    <div class="round-item ${isExtra ? 'extra' : ''}">
                        <div class="round-info">
                            <div class="round-name">${roundName} ${lockStatus}</div>
                            ${timeText ? `<div class="round-time">üïê ${timeText}</div>` : ''}
                            <div class="round-quota">üì¶ ‡∏¢‡∏π‡∏ô‡∏¥‡∏ï+‡∏ö‡∏î: ${r.quota_bags} | üßä ‡∏Å‡πâ‡∏≠‡∏ô ‡∏ã‡∏≠‡∏á: ${r.quota_cubes}</div>
                            ${driverGroupText}
                        </div>
                        <div class="round-actions">
                            ${lockBtn}
                            <button class="btn-del" onclick="deleteRound(${r.id}, ${customerId})">‚úï</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            // ‡πÅ‡∏õ‡∏•‡∏á "06:00:00" -> "06:00"
            return timeStr.substring(0, 5);
        }

        function openAddRoundModal(customerId, name) {
            currentCustomer = { id: customerId, name };
            document.getElementById('roundModalCustomerName').textContent = name;
            document.getElementById('roundNumber').value = '1';
            document.getElementById('roundTimeStart').value = '06:00';
            document.getElementById('roundTimeEnd').value = '08:00';
            document.getElementById('roundQuotaBags').value = '50';
            document.getElementById('roundQuotaCubes').value = '100';
            document.getElementById('roundDeliveryGroup').value = '';
            document.getElementById('roundTimeFields').style.display = 'block';
            document.getElementById('addRoundModal').style.display = 'flex';
        }

        function onRoundNumberChange() {
            const roundNumber = document.getElementById('roundNumber').value;
            const timeFields = document.getElementById('roundTimeFields');
            
            if (roundNumber === 'extra') {
                timeFields.style.display = 'none';
            } else {
                timeFields.style.display = 'block';
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö
                if (roundNumber === '1') {
                    document.getElementById('roundTimeStart').value = '06:00';
                    document.getElementById('roundTimeEnd').value = '08:00';
                } else if (roundNumber === '2') {
                    document.getElementById('roundTimeStart').value = '10:00';
                    document.getElementById('roundTimeEnd').value = '12:00';
                } else if (roundNumber === '3') {
                    document.getElementById('roundTimeStart').value = '14:00';
                    document.getElementById('roundTimeEnd').value = '16:00';
                }
            }
        }

        async function saveRound() {
            const roundNumber = document.getElementById('roundNumber').value;
            const isExtra = roundNumber === 'extra';
            const timeStart = isExtra ? null : document.getElementById('roundTimeStart').value;
            const timeEnd = isExtra ? null : document.getElementById('roundTimeEnd').value;
            const quotaBags = parseInt(document.getElementById('roundQuotaBags').value) || 0;
            const quotaCubes = parseInt(document.getElementById('roundQuotaCubes').value) || 0;
            const deliveryGroupId = document.getElementById('roundDeliveryGroup').value || null;
            
            try {
                await fetch(API.SAVE_ROUND, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: currentCustomer.id,
                        roundNumber,
                        timeStart,
                        timeEnd,
                        quotaBags,
                        quotaCubes,
                        deliveryGroupId
                    })
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                closeModal('addRoundModal');
                loadAndRenderRounds(currentCustomer.id);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function deleteRound(roundId, customerId) {
            if (!confirm("‡∏•‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ?")) return;
            
            try {
                await fetch(API.DELETE_ROUND, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roundId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                loadAndRenderRounds(customerId);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function toggleExtraRound(roundId, customerId, unlock) {
            try {
                await fetch(API.TOGGLE_EXTRA_ROUND, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roundId, unlock })
                });
                alert(unlock ? "‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß" : "üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß");
                loadAndRenderRounds(customerId);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // ==================== MULTIPLIER SECTION ====================
        async function loadAndRenderMultipliers(customerId) {
            const container = document.getElementById(`multipliers-${customerId}`);
            const multipliers = await loadMultipliers(customerId);
            
            let html = '';
            
            if (multipliers.length === 0) {
                html += `<div class="multiplier-warning">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì</div>`;
            } else {
                html += multipliers.map(m => {
                    const productName = MULTIPLIER_PRODUCTS[m.product_code]?.name || m.product_code;
                    return `
                        <div class="multiplier-item">
                            <span class="name">${productName}</span>
                            <span class="value">√ó${m.multiplier}</span>
                            <button class="btn-del" onclick="deleteMultiplier(${m.id}, ${customerId})">‚úï</button>
                        </div>
                    `;
                }).join('');
            }
            
            container.innerHTML = html;
        }

        function toggleCard(el) {
            const body = el.parentElement.querySelector('.card-body-custom');
            body.style.display = body.style.display === 'none' || body.style.display === '' ? 'block' : 'none';
        }

        // ==================== DEPOSIT PERMISSION ====================
        async function toggleDepositPermission(customerId, enabled) {
            try {
                await fetch(API.UPDATE_DEPOSIT_PERMISSION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId, canDeposit: enabled })
                });
                
                const label = document.querySelector(`label[for="deposit-${customerId}"]`);
                if (label) {
                    label.textContent = enabled ? '‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å' : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ù‡∏≤‡∏Å';
                }
            } catch (e) {
                console.error('Error updating deposit permission:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                document.getElementById(`deposit-${customerId}`).checked = !enabled;
            }
        }

        // ==================== MULTIPLIER MODAL ====================
        function openAddMultiplierModal(customerId, name) {
            currentCustomer = { id: customerId, name };
            document.getElementById('multiplierModalCustomerName').textContent = name;
            document.getElementById('multiplierProductCode').value = 'crush_sachet';
            updateMultiplierOptions();
            document.getElementById('addMultiplierModal').style.display = 'flex';
        }

        function updateMultiplierOptions() {
            const productCode = document.getElementById('multiplierProductCode').value;
            const select = document.getElementById('multiplierValue');
            const hint = document.getElementById('multiplierHint');
            const options = MULTIPLIER_PRODUCTS[productCode]?.options || [1];
            
            select.innerHTML = options.map(o => `<option value="${o}">√ó${o}</option>`).join('');
            
            if (productCode === 'crush_sachet') {
                hint.textContent = '‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡πà‡∏á 2 ‡∏ã‡∏≠‡∏á √ó 6 = ‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏° 12 ‡πÉ‡∏ö';
            } else if (productCode === 'cube_kak') {
                hint.textContent = '‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡πà‡∏á 5 ‡∏•‡∏π‡∏Å √ó 2 = ‡∏ñ‡∏∏‡∏á‡∏¢‡∏∑‡∏° 10 ‡πÉ‡∏ö';
            }
        }

        async function saveMultiplier() {
            const productCode = document.getElementById('multiplierProductCode').value;
            const multiplier = document.getElementById('multiplierValue').value;
            
            try {
                await fetch(API.SAVE_MULTIPLIER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: currentCustomer.id,
                        productCode,
                        multiplier: parseInt(multiplier)
                    })
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                closeModal('addMultiplierModal');
                loadAndRenderMultipliers(currentCustomer.id);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function deleteMultiplier(multiplierId, customerId) {
            if (!confirm("‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ô‡∏µ‡πâ?")) return;
            
            try {
                await fetch(API.DELETE_MULTIPLIER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ multiplierId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                loadAndRenderMultipliers(customerId);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // ==================== PROMO SECTION ====================
        async function togglePromoSection(btn, customerId) {
            const body = document.getElementById(`promos-${customerId}`);
            
            if (body.style.display === 'none' || body.style.display === '') {
                body.style.display = 'block';
                btn.innerHTML = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‚ñ≤';
                await loadPromos(customerId);
            } else {
                body.style.display = 'none';
                btn.innerHTML = '‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‚ñº';
            }
        }

        async function loadPromos(customerId) {
            const container = document.getElementById(`promos-${customerId}`);
            try {
                const res = await fetch(API.GET_PROMOS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const promos = await res.json();
                
                if (promos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-text">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£ -</div>
                        <button class="btn btn-warning btn-sm w-100" onclick="openAddPromoModal(${customerId})">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£
                        </button>
                    `;
                } else {
                    let html = promos.map(p => {
                        let promoText = p.promo_type === 'first_bill_free' 
                            ? `‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty}` 
                            : `${p.buy_qty} ‡πÅ‡∏ñ‡∏° ${p.free_qty}`;
                        return `
                            <div class="promo-item">
                                <div class="info">
                                    <div class="product">${p.product_name}</div>
                                    <div class="detail">${promoText} ${p.note ? '(' + p.note + ')' : ''}</div>
                                </div>
                                <button class="btn-del" onclick="deletePromo(${p.id}, ${customerId})">‚úï</button>
                            </div>
                        `;
                    }).join('');
                    
                    html += `<button class="btn btn-warning btn-sm w-100 mt-2" onclick="openAddPromoModal(${customerId})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£</button>`;
                    container.innerHTML = html;
                }
            } catch (e) {
                container.innerHTML = '<div class="text-danger small">Error loading promos</div>';
            }
        }

        // ==================== MODALS ====================
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // LINE ID Modal
        async function openManageLineModal(customerId, name) {
            currentCustomer = { id: customerId, name };
            document.getElementById('lineModalCustomerName').textContent = name;
            document.getElementById('manageLineModal').style.display = 'flex';
            document.getElementById('lineIdList').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            document.getElementById('newLineIdInput').value = '';
            
            try {
                const res = await fetch(API.GET_LINES, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const lines = await res.json();
                
                const validLines = lines.filter(l => l.line_user_id && l.line_user_id !== 'undefined');
                
                if (validLines.length === 0) {
                    document.getElementById('lineIdList').innerHTML = '<div class="text-center text-muted small">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° LINE ID -</div>';
                } else {
                    document.getElementById('lineIdList').innerHTML = validLines.map(l => 
                        `<div class="line-id-tag">
                            <span style="font-size:10px; word-break:break-all;">${l.line_user_id}</span>
                            <button onclick="deleteLineId(${l.id}, '${l.line_user_id}')" style="background:none;border:none;color:#dc3545;cursor:pointer;padding:0 2px;font-size:12px;" title="‡∏•‡∏ö">‚úï</button>
                        </div>`
                    ).join('');
                }
            } catch (e) {
                document.getElementById('lineIdList').innerHTML = '<div class="text-danger small">Error</div>';
            }
        }

        async function deleteLineId(lineId, lineUserId) {
            if (!confirm(`‡∏•‡∏ö LINE ID ‡∏ô‡∏µ‡πâ?\n${lineUserId}`)) return;
            
            try {
                await fetch(API.DELETE_LINE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                openManageLineModal(currentCustomer.id, currentCustomer.name);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function addLineId() {
            const lineId = document.getElementById('newLineIdInput').value.trim();
            if (!lineId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà LINE ID");
            if (!confirm(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${lineId} ‡πÉ‡∏´‡πâ ${currentCustomer.name}?`)) return;
            
            try {
                await fetch(API.ADD_LINE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId, customerId: currentCustomer.id })
                });
                alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß");
                openManageLineModal(currentCustomer.id, currentCustomer.name);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Price Modal
        function openAddPriceModal(customerId, name) {
            currentCustomer = { id: customerId, name };
            document.getElementById('priceModalCustomerName').textContent = name;
            document.getElementById('priceValue').value = '';
            document.getElementById('addPriceModal').style.display = 'flex';
        }

        async function savePrice() {
            const productCode = document.getElementById('priceProductCode').value;
            const price = document.getElementById('priceValue').value;
            if (!price) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤");
            
            const customerId = currentCustomer.id;
            
            try {
                await fetch(API.SAVE_PRICE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: customerId,
                        productCode,
                        price: parseFloat(price)
                    })
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                document.getElementById('priceValue').value = '';
                await loadCustomers();
                setTimeout(() => {
                    const cards = document.querySelectorAll('.customer-card');
                    cards.forEach(card => {
                        const header = card.querySelector('.card-header-custom span');
                        if (header && header.textContent.includes(currentCustomer.name)) {
                            const body = card.querySelector('.card-body-custom');
                            if (body) body.style.display = 'block';
                        }
                    });
                }, 100);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function deletePrice(priceId, productName, customerId, customerName) {
            if (!confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ ${productName}?`)) return;
            
            try {
                await fetch(API.DELETE_PRICE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priceId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                await loadCustomers();
                setTimeout(() => {
                    const cards = document.querySelectorAll('.customer-card');
                    cards.forEach(card => {
                        const header = card.querySelector('.card-header-custom span');
                        if (header && header.textContent.includes(customerName)) {
                            const body = card.querySelector('.card-body-custom');
                            if (body) body.style.display = 'block';
                        }
                    });
                }, 100);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Promo Modal
        function openAddPromoModal(customerId) {
            currentCustomer.id = customerId;
            document.getElementById('promoModalCustomerName').textContent = currentCustomer.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            document.getElementById('promoType').value = 'buy_x_free_y';
            document.getElementById('promoBuyQty').value = '10';
            document.getElementById('promoFreeQty').value = '1';
            document.getElementById('promoFirstBillFreeQty').value = '1';
            document.getElementById('promoNote').value = '';
            togglePromoFields();
            document.getElementById('addPromoModal').style.display = 'flex';
        }

        function togglePromoFields() {
            const type = document.getElementById('promoType').value;
            document.getElementById('buyXFreeYFields').style.display = type === 'buy_x_free_y' ? 'block' : 'none';
            document.getElementById('firstBillFields').style.display = type === 'first_bill_free' ? 'block' : 'none';
        }

        async function savePromo() {
            const productCode = document.getElementById('promoProductCode').value;
            const promoType = document.getElementById('promoType').value;
            const note = document.getElementById('promoNote').value;
            
            let buyQty = null;
            let freeQty = 1;
            
            if (promoType === 'buy_x_free_y') {
                buyQty = parseInt(document.getElementById('promoBuyQty').value) || 10;
                freeQty = parseInt(document.getElementById('promoFreeQty').value) || 1;
            } else {
                freeQty = parseInt(document.getElementById('promoFirstBillFreeQty').value) || 1;
            }
            
            try {
                await fetch(API.ADD_PROMO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: currentCustomer.id,
                        productCode,
                        promoType,
                        buyQty,
                        freeQty,
                        note
                    })
                });
                alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏•‡πâ‡∏ß");
                closeModal('addPromoModal');
                loadPromos(currentCustomer.id);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function deletePromo(promoId, customerId) {
            if (!confirm(`‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡∏ô‡∏µ‡πâ?`)) return;
            
            try {
                await fetch(API.DELETE_PROMO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promoId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                loadPromos(customerId);
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Settings
        async function updateCanSeePrice(customerId, canSeePrice) {
            try {
                await fetch(API.UPDATE_SETTINGS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId, canSeePrice })
                });
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Create Customer
        function openCreateCustomerModal() {
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerLineId').value = '';
            document.getElementById('createCustomerModal').style.display = 'flex';
        }

        async function submitNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const lineId = document.getElementById('newCustomerLineId').value.trim();
            if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
            if (!confirm("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà?")) return;
            
            try {
                await fetch(API.ADD_CUSTOMER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, lineId })
                });
                alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß\n\n‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ!");
                closeModal('createCustomerModal');
                location.reload();
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Delete Customer
        async function deleteCustomer(customerId, customerName) {
            if (!confirm(`‚ö†Ô∏è ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "${customerName}"?\n\n‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:\n- LINE ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å\n- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ\n- ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô\n- ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á\n- ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á`)) return;
            if (!confirm(`‚ùó ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö "${customerName}" ?`)) return;
            
            try {
                await fetch(API.DELETE_CUSTOMER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                alert("‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                location.reload();
            } catch (e) {
                alert("Error: " + e);
            }
        }
    </script>
</body>
</html>
