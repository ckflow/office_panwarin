<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤ (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; padding: 20px; padding-bottom: 80px; }
        .customer-card { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
        .card-header-custom { padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-header-custom:hover { background-color: #f9f9f9; }
        .card-body-custom { padding: 15px; display: none; background-color: #fafafa; }
        .price-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #ddd; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .btn-action-group { display: flex; gap: 5px; margin-top: 15px; }
        .btn-action-group button { flex: 1; border-radius: 8px; }
        .line-id-tag { background: #eef; padding: 5px 10px; border-radius: 20px; font-size: 12px; color: #00c; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
    </style>
</head>
<body>

    <div id="auth-check" class="text-center mt-5"><h4>üîí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</h4></div>

    <div id="content" class="container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h4 class="text-primary fw-bold mb-0">üìã ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4></div>
            <div>
                <button class="btn btn-success btn-sm shadow-sm" onclick="openCreateCustomerModal()"><i class="fas fa-user-plus"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="window.location.reload()"><i class="fas fa-sync"></i></button>
            </div>
        </div>
        <div id="customer-list"><div class="text-center text-muted mt-5">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>
    </div>

    <div id="manageLineModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center text-primary"><i class="fab fa-line"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Line ID</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="lineModalCustomerName" class="fw-bold text-dark">...</span></p>
            
            <div class="mb-3">
                <label class="small text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ:</label>
                <div id="lineIdList" style="background: #f8f9fa; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto;">
                    <div class="text-center text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted">‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÉ‡∏´‡∏°‡πà (‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏á/‡∏™‡∏≤‡∏Ç‡∏≤):</label>
                <div class="input-group">
                    <input type="text" id="newLineIdInput" class="form-control" placeholder="Uxxxxxxxx..." style="font-size: 14px;">
                    <button class="btn btn-primary" onclick="addLineId()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>

            <button class="btn btn-light w-100" onclick="closeModal('manageLineModal')">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="addPriceModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</h5>
            <p class="text-center text-muted mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="modalCustomerName" class="fw-bold text-dark">...</span></p>
            <div class="mb-3"><label class="form-label small text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select id="modalProductCode" class="form-select form-select-lg"></select></div>
            <div class="mb-4"><label class="form-label small text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="modalPrice" class="form-control form-control-lg" placeholder="0"></div>
            <div class="d-flex gap-2"><button class="btn btn-light flex-grow-1" onclick="closeModal('addPriceModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-primary flex-grow-1" onclick="savePrice()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>

    <div id="createCustomerModal" class="modal-overlay">
        <div class="modal-box">
            <h5 class="mb-3 text-center text-success"><i class="fas fa-user-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
            <div class="mb-3"><input type="text" id="newCustomerName" class="form-control form-control-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"></div>
            <div class="mb-4"><input type="text" id="newLineId" class="form-control" placeholder="‡πÉ‡∏™‡πà User ID (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå)"></div>
            <div class="d-flex gap-2"><button class="btn btn-light flex-grow-1" onclick="closeModal('createCustomerModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-success flex-grow-1" onclick="submitNewCustomer()">‡∏™‡∏£‡πâ‡∏≤‡∏á</button></div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k";
        const ALLOWED_ADMINS = ["U4dc8fa32570dca3dfb4093b48a5c2093"];

        // üî• ‡πÅ‡∏Å‡πâ 4 ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        const API_GET_PRICES   = "https://n8n.ckflowsystem.com/webhook/get-prices"; 
        const API_ADD_CUSTOMER = "https://n8n.ckflowsystem.com/webhook/add-customer";
        const API_SAVE_PRICE   = "https://n8n.ckflowsystem.com/webhook/save-price"; 
        const API_GET_LINES    = "https://n8n.ckflowsystem.com/webhook/get-lines"; // ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà 1
        const API_ADD_LINE     = "https://n8n.ckflowsystem.com/webhook/add-line";  // ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà 2

        const masterProducts = [
            { code: 'tube_l', name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà' }, { code: 'tube_s', name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å' },
            { code: 'pack', name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏û‡πá‡∏Ñ' }, { code: 'crush_tube', name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î‡∏´‡∏•‡∏≠‡∏î' }, { code: 'crush_cube', name: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î‡∏Å‡πâ‡∏≠‡∏ô' }
        ];

        let currentCustomer = { name: '', id: null }; 

        async function main() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                if (!ALLOWED_ADMINS.includes(profile.userId)) { document.getElementById('auth-check').innerHTML = `<h3 class="text-danger">‚õî Access Denied</h3>`; return; }
                document.getElementById('auth-check').style.display = 'none'; document.getElementById('content').style.display = 'block';
                loadPrices(); initModalDropdown();
            } catch (err) { alert("Error: " + err); }
        }
        main();

        async function loadPrices() {
            try {
                const response = await fetch(API_GET_PRICES);
                const data = await response.json();
                renderCards(data);
            } catch (err) { console.error(err); }
        }

        function renderCards(data) {
            const container = document.getElementById('customer-list'); container.innerHTML = '';
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.customer_name]) grouped[item.customer_name] = { id: item.customer_id, items: [] };
                if (item.product_code) grouped[item.customer_name].items.push(item);
            });

            Object.keys(grouped).forEach(name => {
                const group = grouped[name];
                let itemsHtml = group.items.map(p => `<div class="price-item"><span>${p.product_name}</span><span style="color:#198754;font-weight:bold;">${p.price}</span></div>`).join('') || `<div class="text-center small text-muted my-3">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© -</div>`;
                
                container.insertAdjacentHTML('beforeend', `
                    <div class="customer-card">
                        <div class="card-header-custom" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                            <span>üë§ ${name}</span><span>‚ñº</span>
                        </div>
                        <div class="card-body-custom">
                            ${itemsHtml}
                            <div class="btn-action-group">
                                <button class="btn btn-outline-primary btn-sm" onclick="openManageLine('${name}', ${group.id})"><i class="fab fa-line"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE</button>
                                <button class="btn btn-primary btn-sm" onclick="openAddPriceModal('${name}')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        // --- Manage Line ID ---
        async function openManageLine(name, id) {
            currentCustomer = { name, id };
            document.getElementById('lineModalCustomerName').innerText = name;
            document.getElementById('manageLineModal').style.display = 'flex';
            document.getElementById('lineIdList').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ID ‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
            try {
                const res = await fetch(API_GET_LINES, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ customerId: id }) });
                const data = await res.json();
                
                let html = '';
                if(data.length === 0) html = '<div class="text-center text-muted small">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å Line ID -</div>';
                else data.forEach(d => html += `<div class="line-id-tag"><span>${d.line_user_id}</span> <i class="fas fa-check-circle"></i></div>`);
                
                document.getElementById('lineIdList').innerHTML = html;
            } catch(e) { document.getElementById('lineIdList').innerText = 'Error loading lines'; }
        }

        async function addLineId() {
            const newId = document.getElementById('newLineIdInput').value.trim();
            if(!newId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Line ID");
            
            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° ID: ${newId} ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ${currentCustomer.name}?`)) {
                try {
                    await fetch(API_ADD_LINE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ lineId: newId, customerId: currentCustomer.id }) });
                    alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    document.getElementById('newLineIdInput').value = '';
                    openManageLine(currentCustomer.name, currentCustomer.id); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                } catch(e) { alert("Error: " + e); }
            }
        }

        // --- Other Modals ---
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function initModalDropdown() { const s = document.getElementById('modalProductCode'); masterProducts.forEach(p => { const o = document.createElement('option'); o.value=p.code; o.text=p.name; s.appendChild(o); }); }
        
        function openAddPriceModal(name) {
            currentCustomerForPrice = name;
            document.getElementById('modalCustomerName').innerText = name;
            document.getElementById('addPriceModal').style.display = 'flex';
        }
        async function savePrice() {
            /* (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) */
             const code = document.getElementById('modalProductCode').value;
             const price = document.getElementById('modalPrice').value;
             if (!price) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤"); return; }
             await fetch(API_SAVE_PRICE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ customer_name: currentCustomerForPrice, product_code: code, price: price }) });
             alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"); closeModal('addPriceModal'); loadPrices();
        }

        function openCreateCustomerModal() { document.getElementById('createCustomerModal').style.display = 'flex'; }
        async function submitNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const lineId = document.getElementById('newLineId').value.trim();
            if (!name) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤?")) {
                await fetch(API_ADD_CUSTOMER, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name, lineId }) });
                alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"); closeModal('createCustomerModal'); location.reload();
            }
        }
    </script>
</body>
</html>


