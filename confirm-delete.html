<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; padding: 20px; }
        .confirm-card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 25px; max-width: 400px; margin: 20px auto; }
        .order-detail { background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
        .detail-label { color: #666; }
        .detail-value { font-weight: bold; }
        .btn-confirm-delete { background: #dc3545; color: white; border: none; border-radius: 25px; padding: 12px 30px; font-size: 16px; font-weight: bold; width: 100%; }
        .btn-confirm-delete:hover { background: #c82333; color: white; }
        .btn-cancel { background: #6c757d; color: white; border: none; border-radius: 25px; padding: 12px 30px; font-size: 16px; width: 100%; margin-top: 10px; }
        .status-msg { text-align: center; padding: 40px 20px; }
        .status-msg.success { color: #198754; }
        .status-msg.error { color: #dc3545; }
        .status-msg.already { color: #ffc107; }
    </style>
</head>
<body>

    <div id="loading" class="text-center mt-5">
        <h4>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h4>
    </div>

    <div id="confirmSection" style="display: none;">
        <div class="confirm-card">
            <h4 class="text-center text-danger mb-3">üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>
            
            <div class="order-detail">
                <div class="detail-row">
                    <span class="detail-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•:</span>
                    <span class="detail-value" id="invoiceNo">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
                    <span class="detail-value" id="customerName">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                    <span class="detail-value" id="orderDate">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                    <span class="detail-value text-success" id="grandTotal">-</span>
                </div>
            </div>
            
            <div id="itemsList" class="mb-3">
                <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong>
                <div id="orderItems" class="mt-2" style="font-size: 13px; color: #666;"></div>
            </div>
            
            <div class="alert alert-warning" style="font-size: 13px;">
                ‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ
            </div>
            
            <button class="btn-confirm-delete" onclick="confirmDelete()">
                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            </button>
            <button class="btn-cancel" onclick="cancelDelete()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>

    <div id="statusSection" style="display: none;">
        <div class="confirm-card">
            <div class="status-msg" id="statusMsg"></div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k";
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        // üî• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        const APPROVER_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093",
            "U5a9979d87d7f62faa2917c0253269be0",
        ];
        
        let deletionId = null;
        let orderId = null;
        let currentUserId = null;

        async function main() {
            try {
                // ‡∏î‡∏∂‡∏á parameters ‡∏à‡∏≤‡∏Å URL
                const params = new URLSearchParams(window.location.search);
                deletionId = params.get('deletionId');
                orderId = params.get('orderId');
                
                if (!deletionId || !orderId) {
                    showStatus('error', '‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                if (!APPROVER_IDS.includes(currentUserId)) {
                    showStatus('error', '‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    return;
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                await loadOrderDetail();
                
            } catch (err) {
                showStatus('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
            }
        }
        main();

        async function loadOrderDetail() {
            try {
                const res = await fetch(`${BASE_URL}/get-deletion-detail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deletionId, orderId })
                });
                const data = await res.json();
                
                if (data.error) {
                    showStatus('error', '‚ùå ' + data.error);
                    return;
                }
                
                if (data.status === 'approved') {
                    showStatus('already', '‚úÖ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                document.getElementById('invoiceNo').textContent = data.invoice_no || '-';
                document.getElementById('customerName').textContent = data.customer_name || '-';
                document.getElementById('orderDate').textContent = formatDate(data.order_date) + ' ' + (data.order_time || '');
                document.getElementById('grandTotal').textContent = parseFloat(data.total || 0).toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                let items = data.items;
                if (typeof items === 'string') {
                    try { items = JSON.parse(items); } catch(e) { items = items.split('\n'); }
                }
                if (Array.isArray(items)) {
                    document.getElementById('orderItems').innerHTML = items.map(i => `<div>‚Ä¢ ${i}</div>`).join('');
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('confirmSection').style.display = 'block';
                
            } catch (e) {
                showStatus('error', '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        async function confirmDelete() {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')) return;
            
            try {
                const res = await fetch(`${BASE_URL}/confirm-delete-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        deletionId,
                        orderId,
                        approvedBy: currentUserId
                    })
                });
                const result = await res.json();
                
                if (result.success) {
                    showStatus('success', '‚úÖ ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    setTimeout(() => {
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        }
                    }, 2000);
                } else {
                    showStatus('error', '‚ùå ' + (result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
                }
            } catch (e) {
                showStatus('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        function cancelDelete() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        function showStatus(type, message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('confirmSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'block';
            
            const msgEl = document.getElementById('statusMsg');
            msgEl.className = 'status-msg ' + type;
            msgEl.innerHTML = `<h4>${message}</h4>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'short' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }
    </script>
</body>
</html>
