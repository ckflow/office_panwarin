<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 30px; font-family: 'Sarabun', sans-serif; }
        .header-section { position: sticky; top: 0; z-index: 999; background-color: #f4f6f9; padding-top: 10px; padding-bottom: 5px; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .date-input-container { display: flex; justify-content: center; align-items: center; background: white; border-radius: 50px; padding: 4px 10px; width: fit-content; max-width: 98%; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #dce0e4; flex-wrap: nowrap; gap: 2px; }
        .date-input { border: none; font-size: 13px; font-weight: bold; color: #0d6efd; outline: none; background: transparent; text-align: center; font-family: 'Sarabun', sans-serif; padding: 0; margin: 0; line-height: 1.2; }
        #orderDate { width: 105px; } #orderTime { width: 75px; }
        .divider { color: #ccc; margin: 0 4px; font-size: 12px; }
        .date-icon { font-size: 13px; margin-right: 3px; color: #0d6efd; }
        
        .product-card { background: white; border-radius: 15px; padding: 12px 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-row { display: flex; align-items: center; justify-content: space-between; }
        .product-info { flex-grow: 1; }
        .product-name { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 0; }
        .product-price { font-size: 12px; color: #666; }
        .product-right { display: flex; align-items: center; gap: 10px; }
        .line-total { font-size: 14px; font-weight: bold; color: #198754; min-width: 70px; text-align: right; }
        .promo-line { font-size: 12px; color: #dc3545; margin-top: 4px; }
        .promo-line i { margin-right: 3px; }
        
        .qty-input { width: 60px; text-align: center; font-size: 18px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 4px; color: #0d6efd; background-color: #fff; }
        
        .borrow-card { background: #e7f1ff; border: 1px solid #b6d4fe; }
        .stepper-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background-color: #6c757d; color: white; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .stepper-btn:active { transform: scale(0.95); }
        .stepper-btn.plus { background-color: #198754; } .stepper-btn.minus { background-color: #dc3545; } 
        .stepper-container { display: flex; align-items: center; gap: 6px; }
        
        .bottom-bar { background: white; padding: 15px; margin: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .cat-title { font-size: 14px; color: #0d6efd; margin: 12px 0 5px 5px; font-weight: bold; border-left: 4px solid #0d6efd; padding-left: 8px; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f4f6f9; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .no-price-msg { text-align: center; padding: 40px 20px; color: #666; }
        
        .multiplier-badge { background: #0d6efd; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <h4>üßä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h4>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center px-3 mb-2">
                <div style="width: 32px;"></div>
                <h4 class="text-center mb-0">üßä ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</h4>
                <button onclick="location.reload()" style="background: none; border: none; font-size: 18px; color: #0d6efd; cursor: pointer;" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="date-input-container">
                <i class="fas fa-calendar-alt date-icon"></i>
                <input type="date" id="orderDate" class="date-input" onchange="checkFirstBill()">
                <span class="divider">|</span>
                <i class="fas fa-clock date-icon"></i>
                <input type="time" id="orderTime" class="date-input">
            </div>
        </div>

        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô) -->
        <div class="container mt-2" id="shopSelectSection" style="display: none;">
            <div class="product-card" style="background: #e7f1ff; border: 1px solid #b6d4fe;">
                <div class="product-info">
                    <div class="product-name text-primary">üè™ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                    <select id="myShopSelect" class="form-select mt-2" onchange="onMyShopSelect()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin) -->
        <div class="container mt-2" id="adminInputSection" style="display: none;">
            <div class="product-card" style="background: #fff3cd; border: 1px solid #ffe69c;">
                <div class="product-info">
                    <div class="product-name text-warning-emphasis">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÄ‡∏≠‡∏á)</div>
                    <select id="customerSelect" class="form-select mt-2" onchange="onCustomerSelect()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="container mt-2" id="productList">
            <!-- Products will be rendered here -->
        </div>

        <div class="container mt-2">
            <div class="cat-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏∏‡∏á</div>
            <div class="product-card">
                <div class="product-row">
                    <div class="product-info"><div class="product-name">‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div></div>
                    <div><input type="number" id="qty_bag_return" class="qty-input" placeholder="0" min="0"></div>
                </div>
            </div>

            <div class="product-card borrow-card">
                <div class="product-row">
                    <div class="product-info">
                        <div class="product-name text-primary">üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div>
                        <div class="product-price">‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                    </div>
                    <div class="stepper-container">
                        <button class="stepper-btn minus admin-only" style="display:none;" onclick="manualAdjustBag(-1)"><i class="fas fa-minus"></i></button>
                        <input type="number" id="qty_bag_borrow" class="qty-input" value="0" min="0" readonly>
                        <button class="stepper-btn plus admin-only" style="display:none;" onclick="manualAdjustBag(1)"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
        <div class="container">
            <div class="bottom-bar">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted" style="font-size: 12px;">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <div class="grand-total" id="grandTotalDisplay" style="font-size: 22px; font-weight: bold; color: #198754;">0 ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <button class="btn btn-primary" style="border-radius: 25px; padding: 12px 30px; font-weight: bold; font-size: 16px;" onclick="openConfirmModal()">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);" onclick="closeConfirmModal()"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div class="text-center mb-3">
                    <div style="width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 15px;"></div>
                    <h5 style="margin: 0;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                </div>
                
                <div id="confirmOrderLines" style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: 14px;">
                    <!-- Order lines will be inserted here -->
                </div>
                
                <div style="border-top: 1px solid #eee; padding-top: 12px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <span id="confirmSubtotal" style="font-weight: bold;">0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="justify-content-between mb-2" id="confirmDiscountRow" style="display: none;">
                        <span class="text-muted">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£</span>
                        <span id="confirmDiscount" style="color: #dc3545; font-weight: bold;">-0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="justify-content-between mb-2" id="confirmDepositRow" style="display: none;">
                        <span class="text-muted">üì¶ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å</span>
                        <span id="confirmDeposit" style="color: #0d6efd; font-weight: bold;">-0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="d-flex justify-content-between" style="border-top: 2px solid #198754; padding-top: 10px; margin-top: 10px;">
                        <span style="font-size: 18px; font-weight: bold;">‚úÖ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span id="confirmGrandTotal" style="font-size: 20px; font-weight: bold; color: #198754;">0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-outline-secondary flex-fill" style="border-radius: 25px; padding: 12px;" onclick="closeConfirmModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button class="btn btn-primary flex-fill" id="finalConfirmBtn" style="border-radius: 25px; padding: 12px; font-weight: bold;" onclick="submitOrder()">
                        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="noPriceScreen" style="display: none;">
        <div class="no-price-msg">
            <h4>üòï ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</h4>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k"; 
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093", //‡πÅ‡∏ä‡∏°‡∏õ‡πå
            "U4cc74cb6346dece926adf6b2a3b7cb77", //‡∏ö‡∏µ
        ]; 

        // Product icons
        const productIcons = {
            'tube_l': 'üçª', 'tube_s': 'ü•§', 'pack_l': 'üÖøÔ∏è', 'pack_s': 'üÖøÔ∏è',
            'crush_sack': 'üõçÔ∏è', 'crush_sachet': 'üì¶', 'crush_white': 'üõçÔ∏è',
            'cube_sachet': 'üßä', 'cube_kak': 'üßä', 'cube_hand': 'üñêÔ∏è', 'sack': 'üì¶'
        };

        // Product categories
        const productCategories = {
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î': ['tube_l', 'tube_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏û‡πá‡∏Ñ': ['pack_l', 'pack_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î': ['crush_white', 'crush_sack', 'crush_sachet'],
            '‡∏Å‡πâ‡∏≠‡∏ô & ‡∏≠‡∏∑‡πà‡∏ô‡πÜ': ['cube_sachet', 'cube_kak', 'cube_hand', 'sack']
        };

        // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ñ‡∏∏‡∏á 1:1
        const productsUseBag = ['tube_l', 'tube_s', 'pack_l', 'crush_sack', 'crush_white'];
        
        // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á
        const MULTIPLIER_PRODUCTS = ['crush_sachet', 'cube_kak'];

        let currentUserId = null;
        let currentCustomerId = null;
        let currentCustomerName = null;
        let isAdmin = false;
        let isFirstBill = false;
        let customerPrices = {}; // { product_code: { price, promo_type, buy_qty, free_qty } }
        let customerMultipliers = {}; // { product_code: multiplier }
        let allCustomers = []; // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)
        let myShops = []; // ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö LINE ID ‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô)
        let pendingDeposits = []; // ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á
        let depositTotal = 0; // ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô

        async function main() {
            try {
                initDateTimeInput();
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isAdmin = ADMIN_IDS.includes(currentUserId);
                
                if (isAdmin) {
                    document.getElementById('adminInputSection').style.display = 'block';
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                    document.getElementById('qty_bag_borrow').removeAttribute('readonly');
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
                    await loadAllCustomers();
                    renderProductsForAdmin();
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö LINE ID
                    await loadMyShops();
                }
                
            } catch (err) { 
                console.error(err);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4>';
            }
        }
        main();

        // ===================== ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (Multi-Shop) =====================
        async function loadMyShops() {
            try {
                const res = await fetch(`${BASE_URL}/get-my-shops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                myShops = await res.json();
                
                if (myShops.length === 0) {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡∏Å
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('noPriceScreen').style.display = 'block';
                } else if (myShops.length === 1) {
                    // ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß - ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡∏¢
                    currentCustomerId = myShops[0].id;
                    currentCustomerName = myShops[0].name;
                    await loadPricesForCustomer(currentCustomerId);
                } else {
                    // ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô - ‡πÅ‡∏™‡∏î‡∏á dropdown ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    const select = document.getElementById('myShopSelect');
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>';
                    myShops.forEach(s => {
                        select.innerHTML += `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`;
                    });
                    
                    document.getElementById('shopSelectSection').style.display = 'block';
                    renderProductsForAdmin(); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                }
                
            } catch (e) {
                console.error('Error loading my shops:', e);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>';
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        async function onMyShopSelect() {
            const select = document.getElementById('myShopSelect');
            const shopId = select.value;
            
            if (!shopId) {
                currentCustomerId = null;
                currentCustomerName = null;
                customerPrices = {};
                customerMultipliers = {};
                pendingDeposits = [];
                depositTotal = 0;
                renderProductsForAdmin();
                updateTotals();
                return;
            }
            
            currentCustomerId = parseInt(shopId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            
            await loadPricesForCustomer(currentCustomerId);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        async function loadPricesForCustomer(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-prices-by-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                
                customerPrices = {};
                data.forEach(item => {
                    if (item.product_code) {
                        customerPrices[item.product_code] = {
                            price: parseFloat(item.price) || 0,
                            promo_type: item.promo_type,
                            buy_qty: item.buy_qty,
                            free_qty: item.free_qty
                        };
                    }
                });
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á‡∏î‡πâ‡∏ß‡∏¢
                await loadMultipliers(customerId);
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á
                await loadPendingDeposits(customerId);
                
                await checkFirstBill();
                renderProducts();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (e) {
                console.error('Error loading prices:', e);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function loadMultipliers(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-multipliers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                
                customerMultipliers = {};
                data.forEach(item => {
                    if (item.product_code) {
                        customerMultipliers[item.product_code] = item.multiplier;
                    }
                });
            } catch (e) {
                console.error('Error loading multipliers:', e);
                customerMultipliers = {};
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function loadPendingDeposits(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-pending-deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                pendingDeposits = Array.isArray(data) ? data : [];
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                depositTotal = 0;
                pendingDeposits.forEach(d => {
                    const price = customerPrices[d.product_code]?.price || 0;
                    const qty = parseInt(d.quantity) || 0;
                    depositTotal += qty * price;
                });
            } catch (e) {
                console.error('Error loading pending deposits:', e);
                pendingDeposits = [];
                depositTotal = 0;
            }
        }

        // ===================== Admin Functions =====================
        async function loadAllCustomers() {
            try {
                const res = await fetch(`${BASE_URL}/get-all-customers`);
                allCustomers = await res.json();
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                allCustomers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`;
                });
            } catch (e) {
                console.error('Error loading customers:', e);
            }
        }

        async function onCustomerSelect() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;
            
            if (!customerId) {
                currentCustomerId = null;
                currentCustomerName = null;
                customerPrices = {};
                customerMultipliers = {};
                pendingDeposits = [];
                depositTotal = 0;
                renderProductsForAdmin();
                updateTotals();
                return;
            }
            
            currentCustomerId = parseInt(customerId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            
            await loadPricesForCustomer(currentCustomerId);
        }

        // ===================== Check First Bill =====================
        async function checkFirstBill() {
            if (!currentCustomerId) return;
            
            try {
                const orderDate = document.getElementById('orderDate').value;
                const res = await fetch(`${BASE_URL}/check-first-bill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: currentCustomerId, orderDate })
                });
                const data = await res.json();
                isFirstBill = data.isFirstBill;
            } catch (e) {
                console.error('Error checking first bill:', e);
                isFirstBill = false;
            }
        }

        // ===================== Render Products =====================
        function renderProducts() {
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                const availableProducts = codes.filter(code => customerPrices[code]);
                
                if (availableProducts.length === 0) continue;
                
                let html = `<div class="cat-title">${category}</div>`;
                
                availableProducts.forEach(code => {
                    const p = customerPrices[code];
                    const icon = productIcons[code] || 'üì¶';
                    const hasMultiplier = MULTIPLIER_PRODUCTS.includes(code);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á badge ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ñ‡∏∏‡∏á (‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
                    let multiplierBadge = '';
                    if (hasMultiplier && customerMultipliers[code]) {
                        multiplierBadge = `<span class="multiplier-badge" id="badge_${code}">√ó${customerMultipliers[code]}‡∏ñ‡∏∏‡∏á</span>`;
                    }
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}${multiplierBadge}</div>
                                    <div class="product-price">${p.price} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                                <div class="product-right">
                                    <span class="line-total" id="total_${code}">0</span>
                                    <input type="number" id="qty_${code}" class="qty-input calculate-trigger" 
                                        placeholder="0" min="0" onchange="calculateAll()" oninput="calculateAll()">
                                </div>
                            </div>
                            <div class="promo-line" id="promo_${code}" style="display:none;"></div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function renderProductsForAdmin() {
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                let html = `<div class="cat-title">${category}</div>`;
                
                codes.forEach(code => {
                    const icon = productIcons[code] || 'üì¶';
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}</div>
                                    <div class="product-price" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                                </div>
                                <div class="product-right">
                                    <input type="number" id="qty_${code}" class="qty-input calculate-trigger" 
                                        placeholder="0" min="0">
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function getProductName(code) {
            const names = {
                'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà', 'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å',
                'crush_sack': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)', 'crush_sachet': '‡∏ö‡∏î(‡∏ã‡∏≠‡∏á)', 'crush_white': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)',
                'cube_sachet': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏ã‡∏≠‡∏á)', 'cube_kak': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏•‡∏π‡∏Å)',
                'cube_hand': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏Å‡∏±‡πä‡∏Å)', 'sack': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö(‡∏°‡∏±‡∏î)'
            };
            return names[code] || code;
        }

        function getUnit(code) {
            const units = {
                'tube_l': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'tube_s': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ',
                'crush_sack': '‡∏ñ‡∏∏‡∏á', 'crush_sachet': '‡∏ã‡∏≠‡∏á', 'crush_white': '‡∏ñ‡∏∏‡∏á',
                'cube_sachet': '‡∏ã‡∏≠‡∏á', 'cube_kak': '‡∏•‡∏π‡∏Å',
                'cube_hand': '‡∏Å‡∏±‡πä‡∏Å', 'sack': '‡∏°‡∏±‡∏î'
            };
            return units[code] || '‡∏´‡∏ô‡πà‡∏ß‡∏¢';
        }

        // ===================== Calculate Totals =====================
        function calculateAll() {
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            for (const code in customerPrices) {
                const qtyEl = document.getElementById(`qty_${code}`);
                if (!qtyEl) continue;
                
                const qty = parseInt(qtyEl.value) || 0;
                const p = customerPrices[code];
                const price = p.price;
                
                let lineTotal = qty * price;
                let discount = 0;
                let promoText = '';
                
                if (qty > 0 && p.promo_type) {
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            discount = freeCount * price;
                            promoText = `üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${discount.toLocaleString()})`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        discount = p.free_qty * price;
                        promoText = `üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${discount.toLocaleString()})`;
                    }
                }
                
                lineTotal -= discount;
                subtotal += qty * price;
                totalDiscount += discount;
                
                const totalEl = document.getElementById(`total_${code}`);
                const promoEl = document.getElementById(`promo_${code}`);
                
                if (totalEl) {
                    totalEl.textContent = qty > 0 ? (qty * price).toLocaleString() : '0';
                }
                if (promoEl) {
                    if (promoText) {
                        promoEl.textContent = promoText;
                        promoEl.style.display = 'block';
                    } else {
                        promoEl.style.display = 'none';
                    }
                }
            }
            
            const safeDepositTotal = depositTotal && !isNaN(depositTotal) ? depositTotal : 0;
            const grandTotal = Math.max(0, subtotal - totalDiscount - safeDepositTotal);
            
            document.getElementById('grandTotalDisplay').textContent = grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            
            autoCalculateBags();
        }

        // ===================== Confirm Modal =====================
        let cachedSubtotal = 0;
        let cachedDiscount = 0;

        function openConfirmModal() {
            // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            if (!currentCustomerId) {
                if (isAdmin) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                } else {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                }
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á order lines
            let orderLines = [];
            let hasItems = false;
            cachedSubtotal = 0;
            cachedDiscount = 0;

            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    hasItems = true;
                    const p = customerPrices[code];
                    const unit = getUnit(code);
                    cachedSubtotal += qty * p.price;
                    
                    let line = `${getProductName(code)}: ${qty} ${unit} = ${(qty * p.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
                    
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            cachedDiscount += freeCount * p.price;
                            line += `<br><span style="color:#dc3545; font-size:12px;">üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${(freeCount * p.price).toLocaleString()})</span>`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        cachedDiscount += p.free_qty * p.price;
                        line += `<br><span style="color:#dc3545; font-size:12px;">üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${(p.free_qty * p.price).toLocaleString()})</span>`;
                    }
                    
                    orderLines.push(line);
                }
            }

            const bagReturnQty = getQty('bag_return');
            if (bagReturnQty > 0) {
                orderLines.push(`‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á: ${bagReturnQty} ‡πÉ‡∏ö`);
            }

            const borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) {
                orderLines.push(`üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);
            }

            if (!hasItems && borrowQty === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // Update modal content
            document.getElementById('confirmOrderLines').innerHTML = orderLines.join('<br>');
            document.getElementById('confirmSubtotal').textContent = cachedSubtotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            
            // Handle discount display - show "-" if no discount
            document.getElementById('confirmDiscount').textContent = cachedDiscount > 0 ? '-' + cachedDiscount.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '-';
            
            // Handle deposit display - show "-" if no deposit or NaN
            const validDeposit = depositTotal && !isNaN(depositTotal) && depositTotal > 0;
            document.getElementById('confirmDeposit').textContent = validDeposit ? '-' + depositTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '-';
            
            const safeDepositTotal = validDeposit ? depositTotal : 0;
            const grandTotal = Math.max(0, cachedSubtotal - cachedDiscount - safeDepositTotal);
            document.getElementById('confirmGrandTotal').textContent = grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';

            // Show/hide rows - always show but with "-" if no value
            document.getElementById('confirmDiscountRow').style.display = cachedDiscount > 0 ? 'flex' : 'none';
            document.getElementById('confirmDepositRow').style.display = (depositTotal && depositTotal > 0) ? 'flex' : 'none';

            // Show modal
            document.getElementById('confirmModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ===================== DateTime & Bag Functions =====================
        function initDateTimeInput() {
            const dateInput = document.getElementById('orderDate');
            const timeInput = document.getElementById('orderTime');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            dateInput.value = formattedDate;
            dateInput.min = formattedDate; 
            const hh = String(today.getHours()).padStart(2, '0');
            const mn = String(today.getMinutes()).padStart(2, '0');
            timeInput.value = `${hh}:${mn}`;
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'long' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function getQty(id) {
            const el = document.getElementById('qty_' + id);
            if (!el) return 0;
            return parseInt(el.value) || 0;
        }

        function autoCalculateBags() {
            let totalBags = 0;
            
            // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ñ‡∏∏‡∏á 1:1 (‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà, ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å, ‡πÅ‡∏û‡πá‡∏Ñ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö, ‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á))
            productsUseBag.forEach(code => { 
                totalBags += getQty(code); 
            });
            
            // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì (‡∏ö‡∏î(‡∏ã‡∏≠‡∏á), ‡∏Å‡πâ‡∏≠‡∏ô(‡∏•‡∏π‡∏Å))
            MULTIPLIER_PRODUCTS.forEach(code => {
                const qty = getQty(code);
                const multiplier = customerMultipliers[code] || 0;
                const bagCount = qty * multiplier;
                totalBags += bagCount;
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó badge ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const badgeEl = document.getElementById(`badge_${code}`);
                if (badgeEl && multiplier > 0) {
                    if (qty > 0) {
                        badgeEl.textContent = `${bagCount}‡∏ñ‡∏∏‡∏á`;
                    } else {
                        badgeEl.textContent = `√ó${multiplier}‡∏ñ‡∏∏‡∏á`;
                    }
                }
            });
            
            document.getElementById('qty_bag_borrow').value = totalBags;
        }

        function manualAdjustBag(amount) {
            let bagInput = document.getElementById('qty_bag_borrow');
            let currentVal = parseInt(bagInput.value) || 0;
            let newVal = currentVal + amount;
            if (newVal < 0) newVal = 0; 
            bagInput.value = newVal;
        }

        // ===================== Submit Order =====================
        async function submitOrder() {
            let orderLines = [];
            let hasItems = false;
            
            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    hasItems = true;
                    const p = customerPrices[code];
                    const unit = getUnit(code);
                    let line = `- ${getProductName(code)}: ${qty} ${unit} (${(qty * p.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            line += `\n  üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${(freeCount * p.price).toLocaleString()})`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        line += `\n  üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${(p.free_qty * p.price).toLocaleString()})`;
                    }
                    
                    orderLines.push(line);
                }
            }

            const bagReturnQty = getQty('bag_return');
            if (bagReturnQty > 0) {
                orderLines.push(`- ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á: ${bagReturnQty} ‡πÉ‡∏ö`);
            }

            const borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) {
                orderLines.push(`------------------\nüëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);
            }

            let btn = document.getElementById('finalConfirmBtn');
            let oldText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            try {
                let finalCustomerName = currentCustomerName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô";
                const safeDepositTotal = depositTotal && !isNaN(depositTotal) ? depositTotal : 0;
                const grandTotal = Math.max(0, cachedSubtotal - cachedDiscount - safeDepositTotal);

                let payload = {
                    lineId: currentUserId,
                    customerId: currentCustomerId,
                    customerName: finalCustomerName,
                    items: orderLines,
                    totalBags: borrowQty,
                    subtotal: cachedSubtotal,
                    discount: cachedDiscount,
                    depositDeduction: safeDepositTotal,
                    total: grandTotal,
                    orderDate: document.getElementById('orderDate').value,
                    orderTime: document.getElementById('orderTime').value
                };

                const response = await fetch(`${BASE_URL}/order-id`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                
                const data = await response.json(); 
                let invoiceNo = data.invoiceNo;

                // Mark deposits as used
                if (pendingDeposits.length > 0 && currentCustomerId) {
                await fetch(`${BASE_URL}/use-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                    customerId: currentCustomerId,
                    orderId: data.orderId || invoiceNo
                })
            });
         }

                const thaiDate = formatDateThai(document.getElementById('orderDate').value);
                const selectedTime = document.getElementById('orderTime').value;

                let messageText = `üßæ ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${invoiceNo}\n` + 
                                  `üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${finalCustomerName}\n` +
                                  `üìã ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate} (${selectedTime} ‡∏ô.)\n` + 
                                  `------------------\n` +
                                  orderLines.join("\n") +
                                  `\n------------------\n` +
                                  `üí∞ ‡∏£‡∏ß‡∏°: ${cachedSubtotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` +
                                  (cachedDiscount > 0 ? `üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${cachedDiscount.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` : '') +
                                  (safeDepositTotal > 0 ? `üì¶ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å: -${safeDepositTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` : '') +
                                  `‚úÖ ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

                closeConfirmModal();

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: messageText }]);
                    liff.closeWindow();
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n" + messageText);
                    location.reload(); 
                }

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>





