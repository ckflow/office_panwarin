<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 120px; font-family: 'Sarabun', sans-serif; }
        .header-section { position: sticky; top: 0; z-index: 999; background-color: #f4f6f9; padding-top: 10px; padding-bottom: 5px; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .date-input-container { display: flex; justify-content: center; align-items: center; background: white; border-radius: 50px; padding: 4px 10px; width: fit-content; max-width: 98%; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #dce0e4; flex-wrap: nowrap; gap: 2px; }
        .date-input { border: none; font-size: 13px; font-weight: bold; color: #0d6efd; outline: none; background: transparent; text-align: center; font-family: 'Sarabun', sans-serif; padding: 0; margin: 0; line-height: 1.2; }
        #orderDate { width: 105px; } #orderTime { width: 75px; }
        .divider { color: #ccc; margin: 0 4px; font-size: 12px; }
        .date-icon { font-size: 13px; margin-right: 3px; color: #0d6efd; }
        
        .product-card { background: white; border-radius: 15px; padding: 12px 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-row { display: flex; align-items: center; justify-content: space-between; }
        .product-info { flex-grow: 1; }
        .product-name { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 0; }
        .product-price { font-size: 12px; color: #666; }
        .product-right { display: flex; align-items: center; gap: 10px; }
        .line-total { font-size: 14px; font-weight: bold; color: #198754; min-width: 70px; text-align: right; }
        .promo-line { font-size: 12px; color: #dc3545; margin-top: 4px; }
        .promo-line i { margin-right: 3px; }
        
        .qty-input { width: 60px; text-align: center; font-size: 18px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 4px; color: #0d6efd; background-color: #fff; }
        
        .borrow-card { background: #e7f1ff; border: 1px solid #b6d4fe; }
        .stepper-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background-color: #6c757d; color: white; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .stepper-btn:active { transform: scale(0.95); }
        .stepper-btn.plus { background-color: #198754; } .stepper-btn.minus { background-color: #dc3545; } 
        .stepper-container { display: flex; align-items: center; gap: 6px; }
        
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .total-section { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .total-section .label { color: #666; }
        .total-section .value { font-weight: bold; }
        .total-section .discount { color: #dc3545; }
        .total-section .grand-total { font-size: 18px; color: #198754; }
        .btn-confirm { width: 100%; border-radius: 30px; padding: 12px; font-size: 18px; font-weight: bold; }
        
        .cat-title { font-size: 14px; color: #0d6efd; margin: 12px 0 5px 5px; font-weight: bold; border-left: 4px solid #0d6efd; padding-left: 8px; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f4f6f9; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .no-price-msg { text-align: center; padding: 40px 20px; color: #666; }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <h4>üßä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h4>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="header-section">
            <h4 class="text-center mb-2">üßä ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</h4>
            <div class="date-input-container">
                <i class="fas fa-calendar-alt date-icon"></i>
                <input type="date" id="orderDate" class="date-input" onchange="checkFirstBill()">
                <span class="divider">|</span>
                <i class="fas fa-clock date-icon"></i>
                <input type="time" id="orderTime" class="date-input">
            </div>
        </div>

        <div class="container mt-2" id="adminInputSection" style="display: none;">
            <div class="product-card" style="background: #fff3cd; border: 1px solid #ffe69c;">
                <div class="product-info">
                    <div class="product-name text-warning-emphasis">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÄ‡∏≠‡∏á)</div>
                    <select id="customerSelect" class="form-select mt-2" onchange="onCustomerSelect()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="container mt-2" id="productList">
            <!-- Products will be rendered here -->
        </div>

        <div class="container mt-2">
            <div class="cat-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏∏‡∏á</div>
            <div class="product-card">
                <div class="product-row">
                    <div class="product-info"><div class="product-name">‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div></div>
                    <div><input type="number" id="qty_bag_return" class="qty-input" placeholder="0" min="0"></div>
                </div>
            </div>

            <div class="product-card borrow-card">
                <div class="product-row">
                    <div class="product-info">
                        <div class="product-name text-primary">üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div>
                        <div class="product-price">‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                    </div>
                    <div class="stepper-container">
                        <button class="stepper-btn minus admin-only" style="display:none;" onclick="manualAdjustBag(-1)"><i class="fas fa-minus"></i></button>
                        <input type="number" id="qty_bag_borrow" class="qty-input" value="0" min="0" readonly>
                        <button class="stepper-btn plus admin-only" style="display:none;" onclick="manualAdjustBag(1)"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="total-section">
                <span class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                <span class="value" id="subtotalDisplay">0 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="total-section" id="discountRow" style="display: none;">
                <span class="label">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£</span>
                <span class="value discount" id="discountDisplay">-0 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="total-section">
                <span class="label">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                <span class="value grand-total" id="grandTotalDisplay">0 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <button class="btn btn-primary btn-confirm" onclick="submitOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
    </div>

    <div id="noPriceScreen" style="display: none;">
        <div class="no-price-msg">
            <h4>üòï ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</h4>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k"; 
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093","U4cc74cb6346dece926adf6b2a3b7cb77"
        ]; 

        // Product icons
        const productIcons = {
            'tube_l': 'üçª', 'tube_s': 'ü•§', 'pack_l': 'üÖøÔ∏è', 'pack_s': 'üÖøÔ∏è',
            'crush_sack': 'üõçÔ∏è', 'crush_sachet': 'üì¶', 'cube_sachet': 'üßä',
            'cube_kak': 'üßä', 'cube_hand': 'üñêÔ∏è', 'sack': 'üì¶'
        };

        // Product categories
        const productCategories = {
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î': ['tube_l', 'tube_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏û‡πá‡∏Ñ': ['pack_l', 'pack_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î': ['crush_sack', 'crush_sachet'],
            '‡∏Å‡πâ‡∏≠‡∏ô & ‡∏≠‡∏∑‡πà‡∏ô‡πÜ': ['cube_sachet', 'cube_kak', 'cube_hand', 'sack']
        };

        // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ñ‡∏∏‡∏á
        const productsUseBag = ['tube_l', 'tube_s', 'pack_l', 'crush_sack'];

        let currentUserId = null;
        let currentCustomerId = null;
        let currentCustomerName = null;
        let isAdmin = false;
        let isFirstBill = false;
        let customerPrices = {}; // { product_code: { price, promo_type, buy_qty, free_qty } }
        let allCustomers = []; // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)

        async function main() {
            try {
                initDateTimeInput();
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isAdmin = ADMIN_IDS.includes(currentUserId);
                
                if (isAdmin) {
                    document.getElementById('adminInputSection').style.display = 'block';
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                    document.getElementById('qty_bag_borrow').removeAttribute('readonly');
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
                    await loadAllCustomers();
                    renderProductsForAdmin();
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏° LINE ID
                    await loadCustomerPrices();
                }
                
            } catch (err) { 
                console.error(err);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4>';
            }
        }
        main();

        async function loadAllCustomers() {
            try {
                const res = await fetch(`${BASE_URL}/get-all-customers`);
                allCustomers = await res.json();
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                allCustomers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`;
                });
            } catch (e) {
                console.error('Error loading customers:', e);
            }
        }

        async function onCustomerSelect() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;
            
            if (!customerId) {
                // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤
                currentCustomerId = null;
                currentCustomerName = null;
                customerPrices = {};
                renderProductsForAdmin();
                updateTotals();
                return;
            }
            
            currentCustomerId = parseInt(customerId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            try {
                const res = await fetch(`${BASE_URL}/get-prices-by-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: currentCustomerId })
                });
                const data = await res.json();
                
                customerPrices = {};
                data.forEach(item => {
                    if (item.product_code) {
                        customerPrices[item.product_code] = {
                            price: parseFloat(item.price) || 0,
                            promo_type: item.promo_type,
                            buy_qty: item.buy_qty,
                            free_qty: item.free_qty
                        };
                    }
                });
                
                await checkFirstBill();
                renderProducts();
                
            } catch (e) {
                console.error('Error loading customer prices:', e);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        async function loadCustomerPrices() {
            try {
                const res = await fetch(`${BASE_URL}/get-customer-prices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                const data = await res.json();
                
                if (data.length === 0 || !data[0].product_code) {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤
                    if (isAdmin) {
                        // Admin ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
                        renderProductsForAdmin();
                    } else {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('noPriceScreen').style.display = 'block';
                        return;
                    }
                } else {
                    currentCustomerId = data[0].customer_id;
                    currentCustomerName = data[0].customer_name;
                    
                    // Map prices and promos
                    data.forEach(item => {
                        if (item.product_code) {
                            customerPrices[item.product_code] = {
                                price: parseFloat(item.price) || 0,
                                promo_type: item.promo_type,
                                buy_qty: item.buy_qty,
                                free_qty: item.free_qty
                            };
                        }
                    });
                    
                    await checkFirstBill();
                    renderProducts();
                }
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (e) {
                console.error('Error loading prices:', e);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>';
            }
        }

        async function checkFirstBill() {
            if (!currentCustomerId) return;
            
            try {
                const orderDate = document.getElementById('orderDate').value;
                const res = await fetch(`${BASE_URL}/check-first-bill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: currentCustomerId, orderDate })
                });
                const data = await res.json();
                isFirstBill = data.isFirstBill;
            } catch (e) {
                console.error('Error checking first bill:', e);
                isFirstBill = false;
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                const availableProducts = codes.filter(code => customerPrices[code]);
                
                if (availableProducts.length === 0) continue;
                
                let html = `<div class="cat-title">${category}</div>`;
                
                availableProducts.forEach(code => {
                    const p = customerPrices[code];
                    const icon = productIcons[code] || 'üì¶';
                    const useBag = productsUseBag.includes(code);
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}</div>
                                    <div class="product-price">${p.price} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                                <div class="product-right">
                                    <span class="line-total" id="total_${code}">0</span>
                                    <input type="number" id="qty_${code}" class="qty-input ${useBag ? 'calculate-trigger' : ''}" 
                                        placeholder="0" min="0" onchange="calculateAll()" oninput="calculateAll()">
                                </div>
                            </div>
                            <div class="promo-line" id="promo_${code}" style="display:none;"></div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            // Add event listeners for bag calculation
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function renderProductsForAdmin() {
            // Admin mode without customer prices - show all products
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                let html = `<div class="cat-title">${category}</div>`;
                
                codes.forEach(code => {
                    const icon = productIcons[code] || 'üì¶';
                    const useBag = productsUseBag.includes(code);
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}</div>
                                    <div class="product-price" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                                </div>
                                <div class="product-right">
                                    <input type="number" id="qty_${code}" class="qty-input ${useBag ? 'calculate-trigger' : ''}" 
                                        placeholder="0" min="0">
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function getProductName(code) {
            const names = {
                'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà', 'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å',
                'crush_sack': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á)', 'crush_sachet': '‡∏ö‡∏î(‡∏ã‡∏≠‡∏á)',
                'cube_sachet': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏ã‡∏≠‡∏á)', 'cube_kak': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏Å‡∏±‡πä‡∏Å)',
                'cube_hand': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏°‡∏∑‡∏≠)', 'sack': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö(‡∏°‡∏±‡∏î)'
            };
            return names[code] || code;
        }

        function getUnit(code) {
            const units = {
                'tube_l': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'tube_s': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ',
                'crush_sack': '‡∏ñ‡∏∏‡∏á', 'crush_sachet': '‡∏ã‡∏≠‡∏á',
                'cube_sachet': '‡∏ã‡∏≠‡∏á', 'cube_kak': '‡∏Å‡∏±‡πä‡∏Å',
                'cube_hand': '‡∏°‡∏∑‡∏≠', 'sack': '‡∏°‡∏±‡∏î'
            };
            return units[code] || '‡∏´‡∏ô‡πà‡∏ß‡∏¢';
        }

        function calculateAll() {
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            for (const code in customerPrices) {
                const qtyEl = document.getElementById(`qty_${code}`);
                if (!qtyEl) continue;
                
                const qty = parseInt(qtyEl.value) || 0;
                const p = customerPrices[code];
                const price = p.price;
                
                let lineTotal = qty * price;
                let discount = 0;
                let promoText = '';
                
                if (qty > 0 && p.promo_type) {
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            discount = freeCount * price;
                            promoText = `üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${discount.toLocaleString()})`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        discount = p.free_qty * price;
                        promoText = `üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${discount.toLocaleString()})`;
                    }
                }
                
                lineTotal -= discount;
                subtotal += qty * price;
                totalDiscount += discount;
                
                const totalEl = document.getElementById(`total_${code}`);
                const promoEl = document.getElementById(`promo_${code}`);
                
                if (totalEl) {
                    totalEl.textContent = qty > 0 ? (qty * price).toLocaleString() : '0';
                }
                if (promoEl) {
                    if (promoText) {
                        promoEl.textContent = promoText;
                        promoEl.style.display = 'block';
                    } else {
                        promoEl.style.display = 'none';
                    }
                }
            }
            
            const grandTotal = subtotal - totalDiscount;
            
            document.getElementById('subtotalDisplay').textContent = subtotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('discountDisplay').textContent = '-' + totalDiscount.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('grandTotalDisplay').textContent = grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            
            if (totalDiscount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
            
            autoCalculateBags();
        }

        function initDateTimeInput() {
            const dateInput = document.getElementById('orderDate');
            const timeInput = document.getElementById('orderTime');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            dateInput.value = formattedDate;
            dateInput.min = formattedDate; 
            const hh = String(today.getHours()).padStart(2, '0');
            const mn = String(today.getMinutes()).padStart(2, '0');
            timeInput.value = `${hh}:${mn}`;
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'long' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function getQty(id) {
            const el = document.getElementById('qty_' + id);
            if (!el) return 0;
            return parseInt(el.value) || 0;
        }

        function autoCalculateBags() {
            let totalBags = 0;
            productsUseBag.forEach(id => { totalBags += getQty(id); });
            document.getElementById('qty_bag_borrow').value = totalBags;
        }

        function manualAdjustBag(amount) {
            let bagInput = document.getElementById('qty_bag_borrow');
            let currentVal = parseInt(bagInput.value) || 0;
            let newVal = currentVal + amount;
            if (newVal < 0) newVal = 0; 
            bagInput.value = newVal;
        }

        async function submitOrder() {
            // Admin ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            if (isAdmin && !currentCustomerId) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }
            
            let orderLines = [];
            let hasItems = false;
            
            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    hasItems = true;
                    const p = customerPrices[code];
                    const unit = getUnit(code);
                    let line = `- ${getProductName(code)}: ${qty} ${unit} (${(qty * p.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    
                    // Add promo info
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            line += `\n  üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${(freeCount * p.price).toLocaleString()})`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        line += `\n  üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${(p.free_qty * p.price).toLocaleString()})`;
                    }
                    
                    orderLines.push(line);
                }
            }

            const bagReturnQty = getQty('bag_return');
            if (bagReturnQty > 0) {
                orderLines.push(`- ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á: ${bagReturnQty} ‡πÉ‡∏ö`);
            }

            const borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) {
                orderLines.push(`------------------\nüëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);
            }

            if (!hasItems && borrowQty === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            let btn = document.querySelector('.btn-confirm');
            let oldText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            try {
                let finalCustomerName = currentCustomerName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô";

                // Calculate totals for payload
                let subtotal = 0, totalDiscount = 0;
                for (const code in customerPrices) {
                    const qty = getQty(code);
                    const p = customerPrices[code];
                    subtotal += qty * p.price;
                    
                    if (qty > 0 && p.promo_type) {
                        if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                            const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                            totalDiscount += freeCount * p.price;
                        } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                            totalDiscount += p.free_qty * p.price;
                        }
                    }
                }
                const grandTotal = subtotal - totalDiscount;

                let payload = {
                    lineId: currentUserId,
                    customerId: currentCustomerId,
                    customerName: finalCustomerName,
                    items: orderLines,
                    totalBags: borrowQty,
                    subtotal: subtotal,
                    discount: totalDiscount,
                    total: grandTotal,
                    orderDate: document.getElementById('orderDate').value,
                    orderTime: document.getElementById('orderTime').value
                };

                const response = await fetch(`${BASE_URL}/order-id`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                
                const data = await response.json(); 
                let invoiceNo = data.invoiceNo;

                const thaiDate = formatDateThai(document.getElementById('orderDate').value);
                const selectedTime = document.getElementById('orderTime').value;

                let messageText = `üßæ ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${invoiceNo}\n` + 
                                  `üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${finalCustomerName}\n` +
                                  `üìã ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate} (${selectedTime} ‡∏ô.)\n` + 
                                  `------------------\n` +
                                  orderLines.join("\n") +
                                  `\n------------------\n` +
                                  `üí∞ ‡∏£‡∏ß‡∏°: ${subtotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` +
                                  (totalDiscount > 0 ? `üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${totalDiscount.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` : '') +
                                  `‚úÖ ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: messageText }]);
                    liff.closeWindow();
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n" + messageText);
                    location.reload(); 
                }

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>


