<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 30px; font-family: 'Sarabun', sans-serif; }
        .header-section { position: sticky; top: 0; z-index: 999; background-color: #f4f6f9; padding-top: 10px; padding-bottom: 5px; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .date-input-container { display: flex; justify-content: center; align-items: center; background: white; border-radius: 50px; padding: 4px 10px; width: fit-content; max-width: 98%; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #dce0e4; flex-wrap: nowrap; gap: 2px; }
        .date-input { border: none; font-size: 13px; font-weight: bold; color: #0d6efd; outline: none; background: transparent; text-align: center; font-family: 'Sarabun', sans-serif; padding: 0; margin: 0; line-height: 1.2; }
        #orderDate { width: 105px; } #orderTime { width: 75px; }
        .divider { color: #ccc; margin: 0 4px; font-size: 12px; }
        .date-icon { font-size: 13px; margin-right: 3px; color: #0d6efd; }
        
        .product-card { background: white; border-radius: 15px; padding: 12px 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-row { display: flex; align-items: center; justify-content: space-between; }
        .product-info { flex-grow: 1; }
        .product-name { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 0; }
        .product-price { font-size: 12px; color: #666; }
        .product-right { display: flex; align-items: center; gap: 10px; }
        .line-total { font-size: 14px; font-weight: bold; color: #198754; min-width: 70px; text-align: right; }
        .promo-line { font-size: 12px; color: #dc3545; margin-top: 4px; }
        .promo-line i { margin-right: 3px; }
        
        .qty-input { width: 60px; text-align: center; font-size: 18px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 4px; color: #0d6efd; background-color: #fff; }
        
        .borrow-card { background: #e7f1ff; border: 1px solid #b6d4fe; }
        .stepper-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background-color: #6c757d; color: white; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .stepper-btn:active { transform: scale(0.95); }
        .stepper-btn.plus { background-color: #198754; } .stepper-btn.minus { background-color: #dc3545; } 
        .stepper-container { display: flex; align-items: center; gap: 6px; }
        
        .bottom-bar { background: white; padding: 15px; margin: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .cat-title { font-size: 14px; color: #0d6efd; margin: 12px 0 5px 5px; font-weight: bold; border-left: 4px solid #0d6efd; padding-left: 8px; }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f4f6f9; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .no-price-msg { text-align: center; padding: 40px 20px; color: #666; }
        
        .multiplier-badge { background: #0d6efd; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 5px; }
        
        /* Product Loading Overlay */
        .product-loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.85);
            z-index: 1500;
            justify-content: center;
            align-items: center;
        }
        
        /* Round Selection Buttons */
        .round-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .round-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 8px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .round-btn:hover { border-color: #0d6efd; color: #0d6efd; }
        .round-btn.active {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }
        .round-btn .round-icon { font-size: 16px; display: block; margin-bottom: 2px; }
        .round-btn.locked {
            background: #f8f9fa;
            border-color: #dee2e6;
            color: #adb5bd;
            cursor: not-allowed;
        }
        .round-btn.locked:hover {
            border-color: #dee2e6;
            color: #adb5bd;
        }
        .round-btn.pickup {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .round-btn.pickup.active {
            background: #ffc107;
            border-color: #e0a800;
            color: #000;
        }
        .pickup-time-container {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffc107;
        }
        .pickup-time-container.show {
            display: block;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #0d6efd;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* My Orders Styles */
        .my-order-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .my-order-header {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .my-order-invoice {
            font-weight: bold;
            color: #0d6efd;
            font-size: 14px;
        }
        .my-order-date {
            font-size: 11px;
            color: #888;
        }
        .my-order-total {
            font-weight: bold;
            color: #198754;
            font-size: 16px;
        }
        .my-order-body {
            padding: 12px 15px;
            background: #fafafa;
        }
        .my-order-items {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
        }
        .my-order-round {
            font-size: 12px;
            color: #0d6efd;
            background: #e7f1ff;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .my-order-actions {
            display: flex;
            gap: 8px;
        }
        .my-order-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1e7dd; color: #0f5132; }
        .status-cancelled { background: #f8d7da; color: #842029; }
        .empty-orders {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-orders i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-screen">
        <h4>üßä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h4>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center px-3 mb-2">
                <div style="width: 32px;"></div>
                <h4 class="text-center mb-0">üßä ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</h4>
                <button onclick="location.reload()" style="background: none; border: none; font-size: 18px; color: #0d6efd; cursor: pointer;" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('order')">üõí ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button class="tab-btn" onclick="switchTab('myorders')">üìã ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        </div>

        <!-- Tab: ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
        <div id="tabOrder" class="tab-content active">
            <div class="container-fluid px-3">
                <div class="date-input-container">
                    <i class="fas fa-calendar-alt date-icon"></i>
                    <input type="date" id="orderDate" class="date-input" onchange="checkFirstBill()">
                    <span class="divider">|</span>
                    <i class="fas fa-clock date-icon"></i>
                    <input type="time" id="orderTime" class="date-input">
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
            <div class="container mt-2" id="roundSelectSection">
                <div class="product-card" style="background: #f0fff4; border: 1px solid #86efac;">
                    <div class="product-info">
                        <div class="product-name text-success mb-2">üöö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
                        <div class="round-btn-group" id="roundButtonGroup">
                            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡πÇ‡∏î‡∏¢ JavaScript -->
                            <div class="text-muted" style="font-size: 13px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô) -->
            <div class="container mt-2" id="shopSelectSection" style="display: none;">
                <div class="product-card" style="background: #e7f1ff; border: 1px solid #b6d4fe;">
                    <div class="product-info">
                        <div class="product-name text-primary">üè™ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                        <select id="myShopSelect" class="form-select mt-2" onchange="onMyShopSelect()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin) -->
            <div class="container mt-2" id="adminInputSection" style="display: none;">
                <div class="product-card" style="background: #fff3cd; border: 1px solid #ffe69c;">
                    <div class="product-info">
                        <div class="product-name text-warning-emphasis">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÄ‡∏≠‡∏á)</div>
                        <select id="customerSelect" class="form-select mt-2" onchange="onCustomerSelect()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="container mt-2" id="productList">
                <!-- Products will be rendered here -->
            </div>

            <!-- Loading Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->
            <div id="productLoading" class="product-loading-overlay">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-2" role="status"></div>
                    <div style="font-size: 14px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤...</div>
                </div>
            </div>

            <div class="container mt-2">
                <div class="cat-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏∏‡∏á</div>
                <div class="product-card">
                    <div class="product-row">
                        <div class="product-info"><div class="product-name">‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div></div>
                        <div><input type="number" id="qty_bag_return" class="qty-input" placeholder="0" min="0"></div>
                    </div>
                </div>

                <div class="product-card borrow-card">
                    <div class="product-row">
                        <div class="product-info">
                            <div class="product-name text-primary">üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div>
                            <div class="product-price">‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                        </div>
                        <div class="stepper-container">
                            <button class="stepper-btn minus admin-only" style="display:none;" onclick="manualAdjustBag(-1)"><i class="fas fa-minus"></i></button>
                            <input type="number" id="qty_bag_borrow" class="qty-input" value="0" min="0" readonly>
                            <button class="stepper-btn plus admin-only" style="display:none;" onclick="manualAdjustBag(1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
            <div class="container">
                <div class="bottom-bar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted" style="font-size: 12px;">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <div class="grand-total" id="grandTotalDisplay" style="font-size: 22px; font-weight: bold; color: #198754;">0 ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                        <button class="btn btn-primary" style="border-radius: 25px; padding: 12px 30px; font-weight: bold; font-size: 16px;" onclick="openConfirmModal()">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
        <div id="tabMyOrders" class="tab-content">
            <div class="container mt-2" id="myOrdersList">
                <div class="text-center text-muted py-4">
                    <div class="spinner-border text-primary mb-2" role="status"></div>
                    <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);" onclick="closeConfirmModal()"></div>
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div class="text-center mb-3">
                    <div style="width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 15px;"></div>
                    <h5 style="margin: 0;">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                </div>
                
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                <div id="confirmRoundInfo" style="background: #f0fff4; border: 1px solid #86efac; border-radius: 10px; padding: 10px 12px; margin-bottom: 12px; text-align: center;">
                    <span style="color: #16a34a; font-weight: bold;">üöö ‡∏£‡∏≠‡∏ö: <span id="confirmRoundText">-</span></span>
                </div>
                
                <div id="confirmOrderLines" style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: 14px;">
                    <!-- Order lines will be inserted here -->
                </div>
                
                <div style="border-top: 1px solid #eee; padding-top: 12px;">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <span id="confirmSubtotal" style="font-weight: bold;">0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="justify-content-between mb-2" id="confirmDiscountRow" style="display: none;">
                        <span class="text-muted">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£</span>
                        <span id="confirmDiscount" style="color: #dc3545; font-weight: bold;">-0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="justify-content-between mb-2" id="confirmDepositRow" style="display: none;">
                        <span class="text-muted">üì¶ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å</span>
                        <span id="confirmDeposit" style="color: #0d6efd; font-weight: bold;">-0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="d-flex justify-content-between" style="border-top: 2px solid #198754; padding-top: 10px; margin-top: 10px;">
                        <span style="font-size: 18px; font-weight: bold;">‚úÖ ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span id="confirmGrandTotal" style="font-size: 20px; font-weight: bold; color: #198754;">0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-outline-secondary flex-fill" style="border-radius: 25px; padding: 12px;" onclick="closeConfirmModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button class="btn btn-primary flex-fill" id="finalConfirmBtn" style="border-radius: 25px; padding: 12px; font-weight: bold;" onclick="submitOrder()">
                        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="noPriceScreen" style="display: none;">
        <div class="no-price-msg">
            <h4>üòï ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</h4>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k"; 
        const BASE_URL = "https://n8n.ckflowsystem.com/webhook";
        
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093", //‡πÅ‡∏ä‡∏°‡∏õ‡πå
            "U4cc74cb6346dece926adf6b2a3b7cb77", //‡∏ö‡∏µ
        ]; 

        const productIcons = {
            'tube_l': 'üçª', 'tube_s': 'ü•§', 'pack_l': 'üÖøÔ∏è', 'pack_s': 'üÖøÔ∏è',
            'crush_sack': 'üõçÔ∏è', 'crush_sachet': 'üì¶', 'crush_white': 'üõçÔ∏è',
            'cube_sachet': 'üßä', 'cube_kak': 'üßä', 'cube_hand': 'üñêÔ∏è', 'sack': 'üì¶'
        };

        const productCategories = {
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î': ['tube_l', 'tube_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏û‡πá‡∏Ñ': ['pack_l', 'pack_s'],
            '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î': ['crush_white', 'crush_sack', 'crush_sachet'],
            '‡∏Å‡πâ‡∏≠‡∏ô & ‡∏≠‡∏∑‡πà‡∏ô‡πÜ': ['cube_sachet', 'cube_kak', 'cube_hand', 'sack']
        };

        const productsUseBag = ['tube_l', 'tube_s', 'pack_l', 'crush_sack', 'crush_white'];
        const MULTIPLIER_PRODUCTS = ['crush_sachet', 'cube_kak'];

        let currentUserId = null;
        let currentCustomerId = null;
        let currentCustomerName = null;
        let isAdmin = false;
        let isFirstBill = false;
        let customerPrices = {};
        let customerMultipliers = {};
        let allCustomers = [];
        let myShops = [];
        let pendingDeposits = [];
        let depositTotal = 0;
        let selectedRound = null;
        let customerRounds = [];
        let myOrders = [];

        const QUOTA_BAG_PRODUCTS = ['tube_l', 'tube_s', 'pack_l', 'pack_s', 'crush_sack', 'crush_sachet', 'crush_white', 'sack'];
        const QUOTA_CUBE_PRODUCTS = ['cube_sachet', 'cube_kak', 'cube_hand'];

        // ==================== TAB FUNCTIONS ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'order') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tabOrder').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tabMyOrders').classList.add('active');
                loadMyOrders();
            }
        }

        // ==================== MY ORDERS FUNCTIONS ====================
        async function loadMyOrders() {
            const container = document.getElementById('myOrdersList');
            container.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border text-primary mb-2"></div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>';
            
            try {
                const res = await fetch(`${BASE_URL}/get-my-orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                myOrders = await res.json();
                if (!Array.isArray(myOrders)) myOrders = [];
                renderMyOrders();
            } catch (e) {
                console.error('Error loading my orders:', e);
                container.innerHTML = '<div class="empty-orders"><i class="fas fa-exclamation-circle"></i><h5>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h5></div>';
            }
        }

        function renderMyOrders() {
            const container = document.getElementById('myOrdersList');
            
            if (!myOrders || myOrders.length === 0) {
                container.innerHTML = '<div class="empty-orders"><i class="fas fa-receipt"></i><h5>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5><p>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p></div>';
                return;
            }
            
            let html = '';
            myOrders.forEach(order => {
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                const canCancel = order.status === 'pending';
                const roundText = getRoundDisplayText(order.delivery_round, order.pickup_time);
                
                html += `
                    <div class="my-order-card">
                        <div class="my-order-header">
                            <div>
                                <div class="my-order-invoice">${order.invoice_no || 'N/A'}</div>
                                <div class="my-order-date">üìÖ ${formatOrderDate(order.order_date)} ${order.order_time || ''}</div>
                            </div>
                            <div class="text-end">
                                <div class="my-order-total">${parseFloat(order.total || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="my-order-body">
                            <div class="my-order-round">üöö ${roundText}</div>
                            <div class="my-order-items">${formatOrderItems(order.order_items)}</div>
                            ${order.total_bags > 0 ? `<div style="font-size:12px; color:#666;">üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${order.total_bags} ‡πÉ‡∏ö</div>` : ''}
                            ${canCancel ? `
                                <div class="my-order-actions mt-3">
                                    <button class="btn btn-outline-danger" onclick="cancelOrder(${order.id}, '${order.invoice_no}')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                                </div>
                            ` : `
                                <div class="text-center mt-2" style="font-size: 12px; color: #888;">
                                    ${order.status === 'confirmed' ? '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ' : ''}
                                    ${order.status === 'cancelled' ? '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'delivered': 'status-confirmed',
                'cancelled': 'status-cancelled'
            };
            return classes[status] || 'status-pending';
        }

        function getStatusText(status) {
            const texts = {
                'pending': '‚è≥ ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                'confirmed': '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'delivered': 'üöö ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                'cancelled': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            };
            return texts[status] || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        }

        function getRoundDisplayText(round, pickupTime) {
            if (round === 'pickup') {
                return `‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á (${pickupTime || '-'} ‡∏ô.)`;
            }
            if (round === 'extra') return '‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°';
            if (round) return `‡∏£‡∏≠‡∏ö ${round}`;
            return '-';
        }

        function formatOrderDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'short' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function formatOrderItems(items) {
            if (!items) return '<span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>';
            
            if (typeof items === 'string') {
                try {
                    items = JSON.parse(items);
                } catch (e) {
                    return items.replace(/\n/g, '<br>');
                }
            }
            
            if (Array.isArray(items)) {
                return items.map(item => `<div>‚Ä¢ ${item}</div>`).join('');
            }
            
            return '<span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>';
        }

        async function cancelOrder(orderId, invoiceNo) {
            if (!confirm(`‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${invoiceNo}?\n\n‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`)) return;
            
            try {
                const res = await fetch(`${BASE_URL}/cancel-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, lineId: currentUserId })
                });
                const result = await res.json();
                
                if (result.success) {
                    alert('‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß');
                    loadMyOrders();
                } else {
                    alert('‚ùå ' + (result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ'));
                }
            } catch (e) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
            }
        }

        // ==================== ROUND FUNCTIONS ====================
        function selectRound(round) {
            const roundData = customerRounds.find(r => r.round_number == round);
            if (!roundData) {
                alert("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ");
                return;
            }
            
            if (round === 'extra' && !roundData.is_unlocked) {
                alert("üîí ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô 0949592455");
                return;
            }
            
            selectedRound = round;
            document.querySelectorAll('.round-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.round-btn[data-round="${round}"]`).classList.add('active');
            
            const pickupContainer = document.getElementById('pickupTimeContainer');
            if (pickupContainer) pickupContainer.classList.remove('show');
        }

        function getRoundText(round) {
            if (round === 'pickup') {
                const time = getPickupTime();
                return `‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á (${time} ‡∏ô.)`;
            }
            
            const roundData = customerRounds.find(r => r.round_number == round);
            if (round === 1 || round === '1') {
                const time = roundData ? `(${formatTime(roundData.time_start)}-${formatTime(roundData.time_end)})` : '';
                return `‡∏£‡∏≠‡∏ö 1 ${time}`;
            }
            if (round === 2 || round === '2') {
                const time = roundData ? `(${formatTime(roundData.time_start)}-${formatTime(roundData.time_end)})` : '';
                return `‡∏£‡∏≠‡∏ö 2 ${time}`;
            }
            if (round === 3 || round === '3') {
                const time = roundData ? `(${formatTime(roundData.time_start)}-${formatTime(roundData.time_end)})` : '';
                return `‡∏£‡∏≠‡∏ö 3 ${time}`;
            }
            if (round === 'extra') return '‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°';
            return '-';
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            return timeStr.substring(0, 5);
        }

        async function loadCustomerRounds(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-customer-rounds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId })
                });
                const data = await res.json();
                customerRounds = Array.isArray(data) ? data : [];
                renderRoundButtons();
            } catch (e) {
                console.error('Error loading rounds:', e);
                customerRounds = [];
                renderRoundButtons();
            }
        }

        function renderRoundButtons() {
            const container = document.getElementById('roundButtonGroup');
            if (!container) return;
            
            let html = '';
            
            if (customerRounds.length === 0) {
                html += `
                    <div class="alert alert-warning mb-2" style="font-size: 13px;">
                        ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÑ‡∏î‡πâ)
                    </div>
                `;
            } else {
                const order = { '1': 1, '2': 2, '3': 3, 'extra': 4 };
                customerRounds.sort((a, b) => (order[a.round_number] || 99) - (order[b.round_number] || 99));
                
                customerRounds.forEach(r => {
                    const isExtra = r.round_number === 'extra';
                    const isLocked = isExtra && !r.is_unlocked;
                    const roundName = isExtra ? '‡πÄ‡∏™‡∏£‡∏¥‡∏°' : `‡∏£‡∏≠‡∏ö ${r.round_number}`;
                    const timeText = isExtra ? '' : `${formatTime(r.time_start)}-${formatTime(r.time_end)}`;
                    const icon = isExtra ? '‚ûï' : ['‚ë†', '‚ë°', '‚ë¢'][parseInt(r.round_number) - 1] || '‚óè';
                    
                    html += `
                        <button type="button" 
                            class="round-btn ${isLocked ? 'locked' : ''}" 
                            data-round="${r.round_number}" 
                            onclick="selectRound('${r.round_number}')"
                            ${isLocked ? 'title="üîí ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ"' : ''}>
                            <span class="round-icon">${isLocked ? 'üîí' : icon}</span>
                            ${roundName}
                            ${timeText ? `<br><small style="font-size:10px;">${timeText}</small>` : ''}
                        </button>
                    `;
                });
            }
            
            html += `
                <button type="button" 
                    class="round-btn pickup" 
                    data-round="pickup" 
                    onclick="selectPickup()">
                    <span class="round-icon">üè≠</span>
                    ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á
                    <br><small style="font-size:10px;">‡∏Ñ‡∏•‡∏¥‡∏Å....</small>
                </button>
            `;
            
            html += `
                <div class="pickup-time-container" id="pickupTimeContainer">
                    <label class="small text-muted">‚è∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö:</label>
                    <input type="time" id="pickupTime" class="form-control mt-1" value="10:00" onchange="updatePickupTime()">
                </div>
            `;
            
            container.innerHTML = html;
            selectedRound = null;
        }

        function selectPickup() {
            selectedRound = 'pickup';
            document.querySelectorAll('.round-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.round-btn.pickup').classList.add('active');
            document.getElementById('pickupTimeContainer').classList.add('show');
        }

        function updatePickupTime() {
            const time = document.getElementById('pickupTime').value;
            console.log('Pickup time:', time);
        }

        function getPickupTime() {
            const input = document.getElementById('pickupTime');
            return input ? input.value : '10:00';
        }

        function checkQuota() {
            if (!selectedRound) return { valid: false, message: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô" };
            
            if (selectedRound === 'pickup') {
                return { valid: true };
            }
            
            const roundData = customerRounds.find(r => r.round_number == selectedRound);
            if (!roundData) return { valid: false, message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ" };
            
            let totalBags = 0;
            let totalCubes = 0;
            
            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    if (QUOTA_BAG_PRODUCTS.includes(code)) {
                        totalBags += qty;
                    } else if (QUOTA_CUBE_PRODUCTS.includes(code)) {
                        totalCubes += qty;
                    }
                }
            }
            
            const quotaBags = roundData.quota_bags || 0;
            const quotaCubes = roundData.quota_cubes || 0;
            
            let errors = [];
            if (quotaBags > 0 && totalBags > quotaBags) {
                errors.push(`‡∏™‡∏±‡πà‡∏á‡∏¢‡∏π‡∏ô‡∏¥‡∏ï+‡∏ö‡∏î: ${totalBags} / ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: ${quotaBags} ‚ùå`);
            }
            if (quotaCubes > 0 && totalCubes > quotaCubes) {
                errors.push(`‡∏™‡∏±‡πà‡∏á‡∏Å‡πâ‡∏≠‡∏ô ‡∏ã‡∏≠‡∏á: ${totalCubes} / ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: ${quotaCubes} ‚ùå`);
            }
            
            if (errors.length > 0) {
                return {
                    valid: false,
                    message: `‚ö†Ô∏è ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ñ‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÑ‡∏´‡∏ß\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô 0949592455\n\n${errors.join('\n')}`
                };
            }
            
            return { valid: true };
        }

        function showProductLoading() {
            document.getElementById('productLoading').style.display = 'flex';
        }
        
        function hideProductLoading() {
            document.getElementById('productLoading').style.display = 'none';
        }

        async function main() {
            try {
                initDateTimeInput();
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return;
                }
                
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isAdmin = ADMIN_IDS.includes(currentUserId);
                
                if (isAdmin) {
                    document.getElementById('adminInputSection').style.display = 'block';
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                    document.getElementById('qty_bag_borrow').removeAttribute('readonly');
                    
                    await loadAllCustomers();
                    renderProductsForAdmin();
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    await loadMyShops();
                }
                
            } catch (err) { 
                console.error(err);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4>';
            }
        }
        main();

        document.addEventListener('visibilitychange', async function() {
            if (document.visibilityState === 'visible' && currentCustomerId) {
                await loadPendingDeposits(currentCustomerId);
                updateTotals();
            }
        });

        let depositPollingInterval = null;
        
        function startDepositPolling() {
            if (depositPollingInterval) clearInterval(depositPollingInterval);
            depositPollingInterval = setInterval(async () => {
                if (currentCustomerId) {
                    await loadPendingDeposits(currentCustomerId);
                    updateTotals();
                }
            }, 10000);
        }
        
        function stopDepositPolling() {
            if (depositPollingInterval) {
                clearInterval(depositPollingInterval);
                depositPollingInterval = null;
            }
        }

        async function loadMyShops() {
            try {
                const res = await fetch(`${BASE_URL}/get-my-shops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lineId: currentUserId })
                });
                myShops = await res.json();
                
                if (myShops.length === 0) {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('noPriceScreen').style.display = 'block';
                } else if (myShops.length === 1) {
                    currentCustomerId = myShops[0].id;
                    currentCustomerName = myShops[0].name;
                    await loadPricesForCustomer(currentCustomerId);
                } else {
                    const select = document.getElementById('myShopSelect');
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô --</option>';
                    myShops.forEach(s => {
                        select.innerHTML += `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`;
                    });
                    
                    document.getElementById('shopSelectSection').style.display = 'block';
                    renderProductsForAdmin();
                    
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                }
                
            } catch (e) {
                console.error('Error loading my shops:', e);
                document.getElementById('loadingScreen').innerHTML = '<h4>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>';
            }
        }

        async function onMyShopSelect() {
            const select = document.getElementById('myShopSelect');
            const shopId = select.value;
            
            if (!shopId) {
                currentCustomerId = null;
                currentCustomerName = null;
                customerPrices = {};
                customerMultipliers = {};
                pendingDeposits = [];
                depositTotal = 0;
                customerRounds = [];
                selectedRound = null;
                stopDepositPolling();
                renderProductsForAdmin();
                renderRoundButtons();
                updateTotals();
                return;
            }
            
            currentCustomerId = parseInt(shopId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            
            showProductLoading();
            await loadPricesForCustomer(currentCustomerId);
            hideProductLoading();
        }

        async function loadPricesForCustomer(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-prices-by-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                
                customerPrices = {};
                data.forEach(item => {
                    if (item.product_code) {
                        customerPrices[item.product_code] = {
                            price: parseFloat(item.price) || 0,
                            promo_type: item.promo_type,
                            buy_qty: item.buy_qty,
                            free_qty: item.free_qty
                        };
                    }
                });
                
                await loadMultipliers(customerId);
                await loadPendingDeposits(customerId);
                await loadCustomerRounds(customerId);
                await checkFirstBill();
                renderProducts();
                startDepositPolling();
                
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (e) {
                console.error('Error loading prices:', e);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        async function loadMultipliers(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-multipliers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                
                customerMultipliers = {};
                data.forEach(item => {
                    if (item.product_code) {
                        customerMultipliers[item.product_code] = item.multiplier;
                    }
                });
            } catch (e) {
                console.error('Error loading multipliers:', e);
                customerMultipliers = {};
            }
        }

        async function loadPendingDeposits(customerId) {
            try {
                const res = await fetch(`${BASE_URL}/get-pending-deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                const data = await res.json();
                pendingDeposits = Array.isArray(data) ? data : [];
                
                depositTotal = 0;
                pendingDeposits.forEach(d => {
                    const price = customerPrices[d.product_code]?.price || 0;
                    const qty = parseInt(d.quantity) || 0;
                    depositTotal += qty * price;
                });
            } catch (e) {
                console.error('Error loading pending deposits:', e);
                pendingDeposits = [];
                depositTotal = 0;
            }
        }

        async function loadAllCustomers() {
            try {
                const res = await fetch(`${BASE_URL}/get-all-customers`);
                allCustomers = await res.json();
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                allCustomers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`;
                });
            } catch (e) {
                console.error('Error loading customers:', e);
            }
        }

        async function onCustomerSelect() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;
            
            if (!customerId) {
                currentCustomerId = null;
                currentCustomerName = null;
                customerPrices = {};
                customerMultipliers = {};
                pendingDeposits = [];
                depositTotal = 0;
                customerRounds = [];
                selectedRound = null;
                stopDepositPolling();
                renderProductsForAdmin();
                renderRoundButtons();
                updateTotals();
                return;
            }
            
            currentCustomerId = parseInt(customerId);
            currentCustomerName = select.options[select.selectedIndex].dataset.name;
            
            showProductLoading();
            await loadPricesForCustomer(currentCustomerId);
            hideProductLoading();
        }

        async function checkFirstBill() {
            if (!currentCustomerId) return;
            
            try {
                const orderDate = document.getElementById('orderDate').value;
                const res = await fetch(`${BASE_URL}/check-first-bill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: currentCustomerId, orderDate })
                });
                const data = await res.json();
                isFirstBill = data.isFirstBill;
            } catch (e) {
                console.error('Error checking first bill:', e);
                isFirstBill = false;
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                const availableProducts = codes.filter(code => customerPrices[code]);
                if (availableProducts.length === 0) continue;
                
                let html = `<div class="cat-title">${category}</div>`;
                
                availableProducts.forEach(code => {
                    const p = customerPrices[code];
                    const icon = productIcons[code] || 'üì¶';
                    const hasMultiplier = MULTIPLIER_PRODUCTS.includes(code);
                    
                    let multiplierBadge = '';
                    if (hasMultiplier && customerMultipliers[code]) {
                        multiplierBadge = `<span class="multiplier-badge" id="badge_${code}">√ó${customerMultipliers[code]}‡∏ñ‡∏∏‡∏á</span>`;
                    }
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}${multiplierBadge}</div>
                                    <div class="product-price">${p.price} ‡∏ö‡∏≤‡∏ó</div>
                                </div>
                                <div class="product-right">
                                    <span class="line-total" id="total_${code}">0</span>
                                    <input type="number" id="qty_${code}" class="qty-input calculate-trigger" 
                                        placeholder="0" min="0" onchange="calculateAll()" oninput="calculateAll()">
                                </div>
                            </div>
                            <div class="promo-line" id="promo_${code}" style="display:none;"></div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function renderProductsForAdmin() {
            const container = document.getElementById('productList');
            container.innerHTML = '';
            
            for (const [category, codes] of Object.entries(productCategories)) {
                let html = `<div class="cat-title">${category}</div>`;
                
                codes.forEach(code => {
                    const icon = productIcons[code] || 'üì¶';
                    
                    html += `
                        <div class="product-card" id="card_${code}">
                            <div class="product-row">
                                <div class="product-info">
                                    <div class="product-name">${icon} ${getProductName(code)}</div>
                                    <div class="product-price" style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                                </div>
                                <div class="product-right">
                                    <input type="number" id="qty_${code}" class="qty-input calculate-trigger" placeholder="0" min="0">
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML += html;
            }
            
            document.querySelectorAll('.calculate-trigger').forEach(input => {
                input.addEventListener('input', autoCalculateBags);
            });
        }

        function getProductName(code) {
            const names = {
                'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà', 'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å',
                'crush_sack': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏ö‡∏µ‡∏ã)', 'crush_sachet': '‡∏ö‡∏î(‡∏ã‡∏≠‡∏á)', 'crush_white': '‡∏ö‡∏î(‡∏ñ‡∏∏‡∏á‡∏Ç‡∏≤‡∏ß)',
                'cube_sachet': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏ã‡∏≠‡∏á)', 'cube_kak': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏•‡∏π‡∏Å)',
                'cube_hand': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏Å‡∏±‡πä‡∏Å)', 'sack': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö(‡∏°‡∏±‡∏î)'
            };
            return names[code] || code;
        }

        function getUnit(code) {
            const units = {
                'tube_l': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö', 'tube_s': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
                'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ',
                'crush_sack': '‡∏ñ‡∏∏‡∏á', 'crush_sachet': '‡∏ã‡∏≠‡∏á', 'crush_white': '‡∏ñ‡∏∏‡∏á',
                'cube_sachet': '‡∏ã‡∏≠‡∏á', 'cube_kak': '‡∏•‡∏π‡∏Å',
                'cube_hand': '‡∏Å‡∏±‡πä‡∏Å', 'sack': '‡∏°‡∏±‡∏î'
            };
            return units[code] || '‡∏´‡∏ô‡πà‡∏ß‡∏¢';
        }

        function calculateAll() { updateTotals(); }

        function updateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            for (const code in customerPrices) {
                const qtyEl = document.getElementById(`qty_${code}`);
                if (!qtyEl) continue;
                
                const qty = parseInt(qtyEl.value) || 0;
                const p = customerPrices[code];
                const price = p.price;
                
                let discount = 0;
                let promoText = '';
                
                if (qty > 0 && p.promo_type) {
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            discount = freeCount * price;
                            promoText = `üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${discount.toLocaleString()})`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        discount = p.free_qty * price;
                        promoText = `üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${discount.toLocaleString()})`;
                    }
                }
                
                subtotal += qty * price;
                totalDiscount += discount;
                
                const totalEl = document.getElementById(`total_${code}`);
                const promoEl = document.getElementById(`promo_${code}`);
                
                if (totalEl) totalEl.textContent = qty > 0 ? (qty * price).toLocaleString() : '0';
                if (promoEl) {
                    if (promoText) { promoEl.textContent = promoText; promoEl.style.display = 'block'; }
                    else { promoEl.style.display = 'none'; }
                }
            }
            
            const safeDepositTotal = depositTotal && !isNaN(depositTotal) ? depositTotal : 0;
            const grandTotal = Math.max(0, subtotal - totalDiscount - safeDepositTotal);
            
            document.getElementById('grandTotalDisplay').textContent = grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            autoCalculateBags();
        }

        let cachedSubtotal = 0;
        let cachedDiscount = 0;

        function openConfirmModal() {
            if (selectedRound !== 'pickup' && customerRounds.length === 0) {
                alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á' ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô 0949592455");
                return;
            }

            if (!selectedRound) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            if (!currentCustomerId) {
                alert(isAdmin ? "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö" : "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            let orderLines = [];
            let hasItems = false;
            cachedSubtotal = 0;
            cachedDiscount = 0;

            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    hasItems = true;
                    const p = customerPrices[code];
                    const unit = getUnit(code);
                    cachedSubtotal += qty * p.price;
                    
                    let line = `${getProductName(code)}: ${qty} ${unit} = ${(qty * p.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
                    
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) {
                            cachedDiscount += freeCount * p.price;
                            line += `<br><span style="color:#dc3545; font-size:12px;">üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${(freeCount * p.price).toLocaleString()})</span>`;
                        }
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        cachedDiscount += p.free_qty * p.price;
                        line += `<br><span style="color:#dc3545; font-size:12px;">üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${(p.free_qty * p.price).toLocaleString()})</span>`;
                    }
                    
                    orderLines.push(line);
                }
            }

            const bagReturnQty = getQty('bag_return');
            if (bagReturnQty > 0) orderLines.push(`‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á: ${bagReturnQty} ‡πÉ‡∏ö`);

            const borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) orderLines.push(`üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);

            if (!hasItems && borrowQty === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            const quotaCheck = checkQuota();
            if (!quotaCheck.valid) {
                alert(quotaCheck.message);
                return;
            }

            document.getElementById('confirmRoundText').textContent = getRoundText(selectedRound);
            document.getElementById('confirmOrderLines').innerHTML = orderLines.join('<br>');
            document.getElementById('confirmSubtotal').textContent = cachedSubtotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('confirmDiscount').textContent = cachedDiscount > 0 ? '-' + cachedDiscount.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '-';
            
            const validDeposit = depositTotal && !isNaN(depositTotal) && depositTotal > 0;
            document.getElementById('confirmDeposit').textContent = validDeposit ? '-' + depositTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '-';
            
            const safeDepositTotal = validDeposit ? depositTotal : 0;
            const grandTotal = Math.max(0, cachedSubtotal - cachedDiscount - safeDepositTotal);
            document.getElementById('confirmGrandTotal').textContent = grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';

            document.getElementById('confirmDiscountRow').style.display = cachedDiscount > 0 ? 'flex' : 'none';
            document.getElementById('confirmDepositRow').style.display = validDeposit ? 'flex' : 'none';

            document.getElementById('confirmModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function initDateTimeInput() {
            const dateInput = document.getElementById('orderDate');
            const timeInput = document.getElementById('orderTime');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            dateInput.value = formattedDate;
            dateInput.min = formattedDate; 
            const hh = String(today.getHours()).padStart(2, '0');
            const mn = String(today.getMinutes()).padStart(2, '0');
            timeInput.value = `${hh}:${mn}`;
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'long' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function getQty(id) {
            const el = document.getElementById('qty_' + id);
            if (!el) return 0;
            return parseInt(el.value) || 0;
        }

        function autoCalculateBags() {
            let totalBags = 0;
            productsUseBag.forEach(code => { totalBags += getQty(code); });
            
            MULTIPLIER_PRODUCTS.forEach(code => {
                const qty = getQty(code);
                const multiplier = customerMultipliers[code] || 0;
                const bagCount = qty * multiplier;
                totalBags += bagCount;
                
                const badgeEl = document.getElementById(`badge_${code}`);
                if (badgeEl && multiplier > 0) {
                    badgeEl.textContent = qty > 0 ? `${bagCount}‡∏ñ‡∏∏‡∏á` : `√ó${multiplier}‡∏ñ‡∏∏‡∏á`;
                }
            });
            
            document.getElementById('qty_bag_borrow').value = totalBags;
        }

        function manualAdjustBag(amount) {
            let bagInput = document.getElementById('qty_bag_borrow');
            let currentVal = parseInt(bagInput.value) || 0;
            let newVal = Math.max(0, currentVal + amount);
            bagInput.value = newVal;
        }

        async function submitOrder() {
            let orderLines = [];
            let hasItems = false;
            
            for (const code in customerPrices) {
                const qty = getQty(code);
                if (qty > 0) {
                    hasItems = true;
                    const p = customerPrices[code];
                    const unit = getUnit(code);
                    let line = `- ${getProductName(code)}: ${qty} ${unit} (${(qty * p.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                    
                    if (p.promo_type === 'buy_x_free_y' && p.buy_qty && p.free_qty) {
                        const freeCount = Math.floor(qty / (p.buy_qty + p.free_qty)) * p.free_qty;
                        if (freeCount > 0) line += `\n  üéÅ ‡πÅ‡∏ñ‡∏° ${freeCount} (-${(freeCount * p.price).toLocaleString()})`;
                    } else if (p.promo_type === 'first_bill_free' && isFirstBill && p.free_qty) {
                        line += `\n  üéÅ ‡∏ö‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏ñ‡∏° ${p.free_qty} (-${(p.free_qty * p.price).toLocaleString()})`;
                    }
                    
                    orderLines.push(line);
                }
            }

            const bagReturnQty = getQty('bag_return');
            if (bagReturnQty > 0) orderLines.push(`- ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á: ${bagReturnQty} ‡πÉ‡∏ö`);

            const borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) orderLines.push(`------------------\nüëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);

            let btn = document.getElementById('finalConfirmBtn');
            let oldText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            try {
                let finalCustomerName = currentCustomerName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô";
                const safeDepositTotal = depositTotal && !isNaN(depositTotal) ? depositTotal : 0;
                const grandTotal = Math.max(0, cachedSubtotal - cachedDiscount - safeDepositTotal);

                let payload = {
                    lineId: currentUserId,
                    customerId: currentCustomerId,
                    customerName: finalCustomerName,
                    items: orderLines,
                    totalBags: borrowQty,
                    subtotal: cachedSubtotal,
                    discount: cachedDiscount,
                    depositDeduction: safeDepositTotal,
                    total: grandTotal,
                    orderDate: document.getElementById('orderDate').value,
                    orderTime: document.getElementById('orderTime').value,
                    deliveryRound: selectedRound,
                    pickupTime: selectedRound === 'pickup' ? getPickupTime() : null
                };

                const response = await fetch(`${BASE_URL}/order-id`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                
                const data = await response.json(); 
                let invoiceNo = data.invoiceNo;

                if (pendingDeposits.length > 0 && currentCustomerId) {
                    await fetch(`${BASE_URL}/use-deposit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            customerId: currentCustomerId,
                            orderId: data.orderId || invoiceNo
                        })
                    });
                }

                if (selectedRound === 'extra') {
                    const roundData = customerRounds.find(r => r.round_number === 'extra');
                    if (roundData) {
                        await fetch(`${BASE_URL}/toggle-extra-round`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ roundId: roundData.id, unlock: false })
                        });
                    }
                }

                const thaiDate = formatDateThai(document.getElementById('orderDate').value);
                const selectedTime = document.getElementById('orderTime').value;

                let messageText = `üßæ ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${invoiceNo}\n` + 
                                  `üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${finalCustomerName}\n` +
                                  `üìã ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate} (${selectedTime} ‡∏ô.)\n` + 
                                  `üöö ${getRoundText(selectedRound)}\n` +
                                  `------------------\n` +
                                  orderLines.join("\n") +
                                  `\n------------------\n` +
                                  `üí∞ ‡∏£‡∏ß‡∏°: ${cachedSubtotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` +
                                  (cachedDiscount > 0 ? `üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${cachedDiscount.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` : '') +
                                  (safeDepositTotal > 0 ? `üì¶ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å: -${safeDepositTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` : '') +
                                  `‚úÖ ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

                closeConfirmModal();

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: messageText }]);
                    liff.closeWindow();
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n" + messageText);
                    location.reload(); 
                }

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
