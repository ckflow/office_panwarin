<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding-bottom: 90px; font-family: 'Sarabun', sans-serif; }
        .header-section { position: sticky; top: 0; z-index: 999; background-color: #f4f6f9; padding-top: 10px; padding-bottom: 5px; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .date-input-container { display: flex; justify-content: center; align-items: center; background: white; border-radius: 50px; padding: 4px 10px; width: fit-content; max-width: 98%; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #dce0e4; flex-wrap: nowrap; gap: 2px; }
        .date-input { border: none; font-size: 13px; font-weight: bold; color: #0d6efd; outline: none; background: transparent; text-align: center; font-family: 'Sarabun', sans-serif; padding: 0; margin: 0; line-height: 1.2; }
        #orderDate { width: 105px; } #orderTime { width: 75px; }
        .divider { color: #ccc; margin: 0 4px; font-size: 12px; }
        .date-icon { font-size: 13px; margin-right: 3px; color: #0d6efd; }
        .product-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .borrow-card { background: #e7f1ff; border: 1px solid #b6d4fe; }
        .product-info { flex-grow: 1; padding-right: 15px; }
        .product-name { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 0; }
        .qty-input { width: 70px; text-align: center; font-size: 20px; font-weight: bold; border: 1px solid #ced4da; border-radius: 8px; padding: 5px; color: #0d6efd; background-color: #fff; }
        .stepper-btn { width: 35px; height: 35px; border-radius: 50%; border: none; background-color: #6c757d; color: white; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .stepper-btn:active { transform: scale(0.95); }
        .stepper-btn.plus { background-color: #198754; } .stepper-btn.minus { background-color: #dc3545; } 
        .stepper-container { display: flex; align-items: center; gap: 8px; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center; z-index: 1000; }
        .btn-confirm { width: 100%; border-radius: 30px; padding: 12px; font-size: 18px; font-weight: bold; }
        .cat-title { font-size: 15px; color: #0d6efd; margin: 15px 0 5px 5px; font-weight: bold; border-left: 4px solid #0d6efd; padding-left: 8px; }
    </style>
</head>
<body>

    <div class="header-section">
        <h4 class="text-center mb-2">üßä ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</h4>
        <div class="date-input-container">
            <i class="fas fa-calendar-alt date-icon"></i>
            <input type="date" id="orderDate" class="date-input">
            <span class="divider">|</span>
            <i class="fas fa-clock date-icon"></i>
            <input type="time" id="orderTime" class="date-input">
        </div>
    </div>

    <div class="container mt-2" id="adminInputSection" style="display: none;">
        <div class="product-card" style="background: #fff3cd; border: 1px solid #ffe69c;">
            <div class="product-info">
                <div class="product-name text-warning-emphasis">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå)</div>
                <input type="text" id="customerName" class="form-control mt-2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
            </div>
        </div>
    </div>

    <div class="container mt-2">
        <div class="cat-title">‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏´‡∏•‡∏≠‡∏î</div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üçª ‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</div></div>
            <div><input type="number" id="qty_tube_l" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">ü•§ ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å</div></div>
            <div><input type="number" id="qty_tube_s" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>

        <div class="cat-title">‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏û‡πá‡∏Ñ</div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üÖøÔ∏è ‡πÅ‡∏û‡πá‡∏Ñ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div></div>
            <div><input type="number" id="qty_pack_l" class="qty-input" placeholder="0" min="0"></div>
        </div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üÖøÔ∏è ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å</div></div>
            <div><input type="number" id="qty_pack_s" class="qty-input" placeholder="0" min="0"></div>
        </div>

        <div class="cat-title">‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ö‡∏î</div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">‚ùÑÔ∏è ‡∏´‡∏•‡∏≠‡∏î‡∏ö‡∏î</div></div>
            <div><input type="number" id="qty_crush_snow" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üßä ‡∏Å‡πâ‡∏≠‡∏ô‡∏ö‡∏î</div></div>
            <div><input type="number" id="qty_crush_cube" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>

        <div class="cat-title">‡∏Å‡πâ‡∏≠‡∏ô & ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üßä ‡∏Å‡πâ‡∏≠‡∏ô (‡∏ã‡∏≠‡∏á)</div></div>
            <div><input type="number" id="qty_cube_sachet" class="qty-input" placeholder="0" min="0"></div>
        </div>

        <div class="product-card">
            <div class="product-info"><div class="product-name">üßä ‡∏Å‡πâ‡∏≠‡∏ô (‡∏Å‡∏±‡πä‡∏Å)</div></div>
            <div><input type="number" id="qty_cube_kak" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üñêÔ∏è ‡∏Å‡πâ‡∏≠‡∏ô (‡∏°‡∏∑‡∏≠)</div></div>
            <div><input type="number" id="qty_cube_hand" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">üì¶ ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏°‡∏±‡∏î‡∏•‡∏∞)</div></div>
            <div><input type="number" id="qty_sack" class="qty-input calculate-trigger" placeholder="0" min="0"></div>
        </div>

        <div class="cat-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏∏‡∏á</div>
        <div class="product-card">
            <div class="product-info"><div class="product-name">‚ôªÔ∏è ‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div></div>
            <div><input type="number" id="qty_bag_return" class="qty-input" placeholder="0" min="0"></div>
        </div>

        <div class="product-card borrow-card">
            <div class="product-info">
                <div class="product-name text-primary">üëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á (‡πÉ‡∏ö)</div>
                <div class="product-desc">‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            </div>
            <div class="stepper-container">
                <button class="stepper-btn minus" onclick="manualAdjustBag(-1)"><i class="fas fa-minus"></i></button>
                <input type="number" id="qty_bag_borrow" class="qty-input" value="0" min="0">
                <button class="stepper-btn plus" onclick="manualAdjustBag(1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-primary btn-confirm" onclick="submitOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2008689090-CnrdxM5k"; 
        const N8N_WEBHOOK_URL = "https://n8n.ckflowsystem.com/webhook/order-id"; 

        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Admin (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const ADMIN_IDS = [
            "U4dc8fa32570dca3dfb4093b48a5c2093",
            // "Uyyyyyyyyyyyyyyyyyyyyyyyyyyyy", // ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏Å‡πä‡∏≠‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
        ]; 

        const products = {
            'tube_l': '‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà', 'tube_s': '‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡πá‡∏Å', 'pack_l': '‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà', 'pack_s': '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏•‡πá‡∏Å',
            'crush_snow': '‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î(‡πÄ‡∏Å‡∏•‡πá‡∏î‡∏´‡∏¥‡∏°‡∏∞)', 'crush_cube': '‡∏ö‡∏î‡∏Å‡πâ‡∏≠‡∏ô', 'cube_sachet': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏ã‡∏≠‡∏á)',
            'cube_kak': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏Å‡∏±‡πä‡∏Å)', 'cube_hand': '‡∏Å‡πâ‡∏≠‡∏ô(‡∏°‡∏∑‡∏≠)', 'sack': '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö',
            'bag_return': '‡∏Ñ‡∏∑‡∏ô‡∏ñ‡∏∏‡∏á', 'bag_borrow': '‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á'
        };

        const productsUseBag = [
            'tube_l', 'tube_s', 'crush_snow', 'crush_cube', 
            'cube_kak', 'cube_hand', 'sack'
        ];

        async function main() {
            try {
                initDateTimeInput();
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                } else {
                    checkAdminPermission();
                }
            } catch (err) { console.error(err); }
        }
        main();

        async function checkAdminPermission() {
            try {
                const profile = await liff.getProfile();
                const currentUserId = profile.userId;
                if (ADMIN_IDS.includes(currentUserId)) {
                    document.getElementById('adminInputSection').style.display = 'block';
                } else {
                    document.getElementById('adminInputSection').style.display = 'none';
                }
            } catch (err) { console.error(err); }
        }

        function initDateTimeInput() {
            const dateInput = document.getElementById('orderDate');
            const timeInput = document.getElementById('orderTime');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            dateInput.value = formattedDate;
            dateInput.min = formattedDate; 
            const hh = String(today.getHours()).padStart(2, '0');
            const mn = String(today.getMinutes()).padStart(2, '0');
            timeInput.value = `${hh}:${mn}`;
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.toLocaleDateString('th-TH', { month: 'long' });
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function getQty(id) {
            let val = document.getElementById('qty_' + id).value;
            return val ? parseInt(val) : 0;
        }

        function autoCalculateBags() {
            let totalBags = 0;
            productsUseBag.forEach(id => { totalBags += getQty(id); });
            document.getElementById('qty_bag_borrow').value = totalBags;
        }

        document.querySelectorAll('.calculate-trigger').forEach(input => {
            input.addEventListener('input', autoCalculateBags);
        });

        function manualAdjustBag(amount) {
            let bagInput = document.getElementById('qty_bag_borrow');
            let currentVal = parseInt(bagInput.value) || 0;
            let newVal = currentVal + amount;
            if (newVal < 0) newVal = 0; 
            bagInput.value = newVal;
        }

        async function submitOrder() {
            let orderLines = [];
            for (let key in products) {
                if(key === 'bag_borrow') continue;
                let qty = getQty(key);
                if (qty > 0) {
                    let unit = '‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö';
                    if (['pack_l', 'pack_s', 'cube_sachet'].includes(key)) unit = '‡πÅ‡∏û‡πá‡∏Ñ/‡∏ã‡∏≠‡∏á';
                    if (key === 'cube_kak') unit = '‡∏Å‡∏±‡πä‡∏Å';
                    if (key === 'bag_return') unit = '‡πÉ‡∏ö';
                    orderLines.push(`- ${products[key]}: ${qty} ${unit}`);
                }
            }

            let borrowQty = getQty('bag_borrow');
            if (borrowQty > 0) orderLines.push(`------------------\nüëú ‡∏¢‡∏∑‡∏°‡∏ñ‡∏∏‡∏á: ${borrowQty} ‡πÉ‡∏ö`);

            if (orderLines.length === 0 && borrowQty === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            let btn = document.querySelector('.btn-confirm');
            let oldText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            try {
                const profile = await liff.getProfile();
                const currentUserId = profile.userId;
                let finalCustomerName = "";
                
                if (ADMIN_IDS.includes(currentUserId)) {
                    let inputName = document.getElementById('customerName').value.trim();
                    finalCustomerName = inputName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)";
                } else {
                    finalCustomerName = profile.displayName; 
                }

                let payload = {
                    lineId: currentUserId,
                    customerName: finalCustomerName,
                    items: orderLines,
                    totalBags: borrowQty,
                    orderDate: document.getElementById('orderDate').value,
                    orderTime: document.getElementById('orderTime').value
                };

                const response = await fetch(N8N_WEBHOOK_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                
                const data = await response.json(); 
                
                // üî• ‡πÉ‡∏ä‡πâ invoiceNo ‡∏à‡∏≤‡∏Å server ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                let invoiceNo = data.invoiceNo;

                const selectedDate = document.getElementById('orderDate').value;
                const selectedTime = document.getElementById('orderTime').value;
                const thaiDate = formatDateThai(selectedDate);

                let messageText = `üßæ ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${invoiceNo}\n` + 
                                  `üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${finalCustomerName}\n` +
                                  `üìã ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate} (${selectedTime} ‡∏ô.)\n` + 
                                  `------------------\n` +
                                  orderLines.join("\n");

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: messageText }]);
                    liff.closeWindow();
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n" + messageText);
                    location.reload(); 
                }

            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
